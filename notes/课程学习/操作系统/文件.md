## 数据项、记录和文件

#### 数据项

在文件系统中，数据项时最低级的数据组织形式

1）基本数据项

基本数据项又称字段，是用于描述一个对象的某种属性的字符集，是数据组织中可以命名的最小逻辑数据单位。

2）组合数据项

组合数据项是由若干个基本数据项组成的，简称组项。

例如工资是个组项，它可由基本工资、工龄工资和奖励工资等基本项所组成。

#### 记录

记录是一组相关数据项的集合，用于描述一个对象在某方面的属性。

#### 文件

文件是指由创建者所定义的、具有文件名的一组相关元素的集合。

文件在文件系统中是一个最大的数据单位，它描述了一个对象集。例如，可以将一个班的学生记录作为一个文件。

## 文件系统模型

如下图所示，文件系统模型可分为三个层次：最底层是对象及其属性，中间层是对对象操纵和管理的软件集合，最高层是文件系统提供给用户的接口。

<img src=".\pictures\文件系统模型.png" alt="文件系统模型" style="zoom:80%;" />

1）对象及其属性

文件管理系统管理的对象如下：

* 文件

* 目录

  对目录的组织和管理，是方便用户和提高对文件存取速度的关键

* 磁盘（磁带）存储空间

  文件和目录必定占用存储空间，对这部分空间的有效管理，不仅能提高外村的利用率，而且能提高对文件的存取速度。

2）对对象操纵和管理的软件集合

该层是文件系统的核心部分，文件系统的功能大多在该层实现：

* 对文件存储空间的管理
* 将文件的逻辑地址转换为物理地址

一般地，把与文件系统有关的软件分为四个层次：

* I/O控制层
* 基本文件系统层
* 基本I/O管理程序
* 逻辑文件系统

3）文件系统接口

* 命令接口

  指作为用户与文件系统直接交互的接口

* 程序接口

  指作为用户程序与文件系统的接口

## 文件的逻辑结构

### 无结构文件

由一系列二进制或字符流组成

### 有结构文件

#### 顺序文件

顺序文件的排列方式：

* 串结构

  在串结构文件中的记录，通常是按时间的先后进行排序的，各记录之间的顺序与关键字无关。

  每次检索文件需从头开始。

* 顺序结构

  由用户指定一个字段作为关键字，文件中的所有记录可以按关键字排序、按关键字的大小排序等等。

最佳应用场合时在对文件中的记录进行批量存取时。

#### 索引文件

按关键字建立索引

相当于对可变长文件建立索引表 索引表是定长记录的顺序文件

将需要顺序查找的文件改造称一个可随机查找的文件，极大地提高了对文件地查找速度。

#### 索引顺序文件

索引顺序文件是顺序文件和索引文件相结合地产物，能有效地克服变长记录文件的缺点。

解决索引文件中的索引表项比文件还大的问题，将不同文件进行分组，一组记录对应一个表项 

索引顺序文件是定长记录的串结构的文件 想找某个关键字的值，先找到该关键字所在组，再向该组去找

#### 直接文件

直接文件可根据给定的关键字直接获得指定记录的物理地址。

由关键字到记录物理地址的转换被称为键值转换。

#### 哈希文件

哈希文件是目前应用最为广泛的一种直接文件

## 文件的物理结构

注意：文件在磁盘上通常采用连续存放的方法，在内存上采用随机存放的方法。

存储介质分外存和内存。物理结构指存放方式。

#### 连续分配

要求每个文件在磁盘上占有一组连续的块，只适用于长度固定的文件

文件在顺序读写时速度最快

不方便文件扩展；存储空间利用率低；会产生磁盘外部碎片

#### 链接分配

连接分配是一种采用离散分配的方式，它消除了磁盘的外部碎片，提高了磁盘的利用率。

1）隐式链接（默认）

每个物理块里记录下一个块号

只支持顺序访问，不支持随机访问，查找效率低

方便文件扩展，所有的空闲磁盘块可以被利用，，不会有文件碎片问题，外存利用率高

2）显示链接

文件分配表（FAT）记录每个物理块号的下一个块号,整个系统只有一个FAT

常驻内存

支持随机访问

文件分配表（FAT）需要占用一定的存储空间

#### 索引分配

每个文件有一张索引表，索引表记录了该文件的逻辑块号对应的物理块号

索引分配的优点使支持直接访问，且没有外部碎片。缺点使由于索引块的分配，增加了存储空间的开销。

链接方案：索引表太大，对其进行拆分。构建一链表，链表里的每个索引块指向索引表的各个部分，再从索引表中读出物理块号

多层索引：类比多级页表，n层索引读出数据需要n+1次访存

#### 混合索引分配

直接地址、一层索引、多层索引混用

## 目录管理

1）单级目录

查找速度慢、不允许重名、不便于实现文件共享

2）二级目录

3）多级目录

## 目录查询

1）线性检索法

线性检索法又称顺序检索法

目录查询通常采用顺序检索法。在查找完成后，得到的是文件的逻辑地址。

2）Hash方法

## 文件共享

#### 基于有向无循环图

1）有向无循环图：

<img src=".\pictures\有向无循环图目录层次.png" alt="有向无循环图目录层次" style="zoom:80%;" />

问题：新增加的内容仅对操作的用户可见，对其它共享的用户不可见。

2）利用索引结点（硬链接）

利用索引结点可解决上述问题。即诸如文件的物理地址及其它的文件属性等信息，不再放在目录项中，而是放在索引结点中。

在索引结点中有一个链接计数count，用于表示链接到本索引结点上的用户目录项数。例如当用户A创建一个新文件时，他便是该文件的所有者，此时将count置为1，当用户B共享此文件时，在用户B的目录中增加一目录项，并设置一指针指向该文件的索引结点，此时文件主仍时用户A。如果用户A要删除此文件，会将该文件的索引结点一并删除，其必须等待用户B的正在访问的操作结束。

建立硬链接时，引用计数值加1

#### 基于符号链接（软链接）

类似于 Windows 操作系统的"快捷方式"，其通过记录的路径去查找文件，会多次读磁盘，速度较慢

<img src=".\pictures\使用符号链接的目录层次.png" alt="使用符号链接的目录层次" style="zoom:80%;" />

利用符号链接实现文件共享时，只有文件主才拥有指向索引结点的指针；而共享该文件的其他用户则只有该文件的路径名，并不拥有指向其索引结点的指针。

问题：每次访问共享文件时，都可能要多次地读磁盘。这使每次访问文件的开销甚大，且增加了启动磁盘的频率。此为要为每个共享用户建立一条符号链，而由于符号链本身实际上使一个文件，尽管该文件非常简单，却仍要为它配置一个索引结点，这也要耗费一定的磁盘空间。

建立软链接时，引用计数值直接复制。当删除源文件时，对软链接是不可见的

设文件F1的当前引用计数值为1，先建立文件F1的符号链接（软链接）文件F2，此时F1和F2的引用计数值都为1。再建立文件F1的硬链接文件F3，此时F1和F3的引用计数值就都变成了2，然后删除文件F1，F3的引用计数值变成了1，F2的引用计数值不变，仍为1。

## 文件保护

1）口令保护
	优点：保存口令的空间开销小，验证口令的时间开销小
2）加密保护
	例如 异或加密
	优点：保密性强，不需要再系统中存储密码
	缺点：编译、译码，加   密、解密需要花费一定的时间
3）访问控制
实现灵活，可以实现复杂的文件保护功能

对文件的访问控制，常采用**用户访问权限**和**文件属性**共同限制。



防止文件受损常采用备份的方法，而存取控制矩阵方法用于多用户之间的存取权限保护。

## 文件存储空间的管理

#### 空闲表法

#### 空闲链表法

#### 位视图法

#### 成组链接法





