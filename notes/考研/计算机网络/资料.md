## 第一章 计算机网络和因特网

计算机网络和分布式系统之间的区别更多的在于高层软件，而不是物理结构。

因特网标准制定的四个阶段：因特网草案（Internet Draft）、建议标准（Proposed Standard）、草案标准（Draft Standard）、因特网标准（Internet Standard）。

因特网发展的三个主要阶段：

* 从单个网络ARPANET向互联网发展的过程

  主要特点：TCP/IP协议初步成型

* 建成了三级结构的因特网

  主要特点：因特网分为主干网、地区网和校园网

* 形成了多层次ISP结构的因特网

  主要特点：ISP首次出现

### 第一节 计算机网络的相关定义及分类

#### 一、计算机网络的相关概念

计算机网络就是利用通信设备和线路将地理位置不同的、功能独立的多个计算机系统互联起来，以功能完善的网络软件实现网络中<u>资源共享</u>和<u>信息传递</u>的系统。

世界上出现的最早计算机网络是 ARPAnet，同时也是 Internet 的最早起源。

在计算机网络中端系统与主机的含义相同。主机有时又被进一步划分为客户和服务器。端系统列举：手机、平板电脑、环境传感器、网络服务器等。

##### （一）接入技术

广域无线接入技术：

* LTE
* 3G、4G、5G

家庭接入技术

* 拨号

* 数字用户线(Digital Subscriber Line，DSL)

* 电缆

  电缆因特网接入需要特殊的调制解调器，这种调制解调器称为电缆调制解调器。

  电缆调制解析器将HFC网络划分为下行和上行信道。

  上行通常指从终端设备（如手机）向网络中心（如基站）传输数据的方向，而下行则指从网络中心向终端设备传输数据的方向。

  上行速率和下行速率可以简单理解为上传速率和下载速率。

  混合光纤同轴（Hybrid Fiber Coax，HFC）系统的传输速率是用户共享的。由头端发送的每个分组向下行进每段链路到每个用户，因此在下行信道中不会发生碰撞。每个用户发送的每个分组经上行信道向头端传输，所以在上行信道中可能发生碰撞，需要一个分布式多路访问协议来协调传输和避免碰撞。

* 光纤到户(Fiber To The Home，FTTH)

  FTTH的传输速率是用户独享的。

* 卫星

企业（和家庭）接入技术：

* 以太网
* WiFI

主干网和本地接入网的主要区别：

* 主干网用来提供远程覆盖、高速传输和路由器最优化通信。
* 本地接入网用来支持用户访问本地，把用户接入到互联网，速率较低。

我们常说几M的带宽和我们实际使用过程中的下载速度是不同的，因为运行商的计算单位是bit，而我们实际下载时显示的单位是Byte。所以在生活中的100M的宽带的实际下载速度大约只有 100M/8 = 12.5M 。

#### 二、计算机网络的组成部分

从组成部分上看，计算机网络主要由<u>硬件</u>、<u>软件</u>、<u>协议</u>三大部分组成。

从逻辑功能上看，计算机网络由<u>通信子网</u>和<u>资源子网</u>组成。

从工作方式上看，计算机网络可分为边缘部分和核心部分。

##### （一）硬件

硬件主要由主机（也称端系统）、通信链路、交换设备（如路由器、交换机）和通信处理机（如网卡）等组成。

通信链路是由物理链路（如双绞线、同轴电缆、光纤）连接在一起组成的。

##### （二）软件

软件主要包括各种实现资源共享的软件和方便用户使用的各种工具软件。操作系统是最基本的软件。

##### （三）协议

协议：定义了在两个或多个通信实体之间交换的报文的格式和顺序，以及报文发送和/或接收一条报文或其他事件所采取的动作。

网络协议三要素：

* 语义：涉及用于协调与差错处理的控制信息。
* 语法：涉及数据及控制信息的格式、编码及信号电平等。
* 时序：涉及报文传输的先后顺序。

##### （五）通信子网

通信子网由各种传输介质、通信设备和相应的网络协议组成，它使网络具有数据传输、交换、控制和存储的能力，实现联网计算机之间的数据通信。

通信子网包括物理层、链路层、网络层。网桥、交换机、路由器都属于通信子网。

##### （六）资源子网

资源子网是实现资源共享功能的设备及其软件的集合，由网络用户提供其他计算机上的硬件资源、软件资源和数据资源。

#### 三、计算机网络的分类

从分布范围（或作用范围、覆盖范围）上看，可分为：

* 广域网（WAN，Wide Area Network）
* 城域网（MAN，Metropolitan Area Network）
* 局域网（LAN，Local Area Network）
* 个人区域网（PAN，Personal Area Network）

广播式网络采用广播技术共享公共信道，两对（四个）节点之间的通信可能会互相干扰而失败,解决方法是介质访问控制。

点对点网络独占链路信道，采用第3层（网络层）交换技术，其中分组交换就采用了分组存储转发和路由选择机制。


<img src=".\picture\网络.png" alt="网络" style="zoom:50%;" />

##### （一）广域网

广域网基本都属于点对点网络，采用交换技术。

广域网由一些结点交换机（注意不是路由器）及连接这些交换机的链路组成。

|                   |                            广域网                            |          局域网          |
| :---------------: | :----------------------------------------------------------: | :----------------------: |
|     覆盖范围      |                       很广，通常跨区域                       |  较小，通常在一个区域内  |
|     连接方式      | 结点之间都是点到点连接，但为了提高国内网络的可靠性，一个结点交换机往往与多个结点交换机相连 |   普遍采用多点接入技术   |
| 对应 OSI 参考模型 |               三层：物理层，数据链路层，网络层               | 两层：物理层，数据链路层 |
|      着重点       |                         强调资源共享                         |       强调数据传输       |

##### （二）局域网

局域网使用广播技术，工作在数据链路层，不需要网络层，不存在路由选择问题。

局域网接入广域网主要通过路由器来实现。

从网络的使用者进行分类：

* 公用网
* 专用网

#### 四、计算机网络的拓扑结构

网络拓扑结构是指由网中结点（路由器、主机等）与通信线路（网线之间的几何关系）表示的网络结构，主要指<u>通信子网</u>的拓扑结构。

按网络的拓补结构主要分为总线形、星形、环形和网状形。

总线形、星形和环形网络多用于局域网，网状网络多用于广域网。

##### （一）总线形网络

优点是建网容易、增或减结点方便、节省线路。

缺点是重负载时通信效率不高、总线任意一处对故障敏感。

##### （二）星形网络

每个终端或计算机都以单独的线路与中央设备相连。中央设备一般是交换机或路由器。

优点是便于集中控制和管理，因为端用户之间的通信必须经过中央设备。

##### （三）环形网络

环中信号是单向传输的。

##### （四）网状网络

优点是可靠性高。

缺点是控制复杂、线路成本高。

#### 五、计算机网络的交换技术

##### （一）电路交换

电路交换技术分为三个阶段：连接建立、数据传输和连接释放。

电路交换的关键点是，在数据传输的过程中，用户<u>始终占有</u>端到端的固定传输带宽。

若发送方将以稳定速率发送数据且持续较长时间，则应该选择电路交换而不是分组交换。

电路交换网络中有n个交换机，k条链路，每条链路都有n条电路（书上原话，可理解为每条链路都连接了n台交换机），则该网络中共有nk条连接，每增加1条连接了n台交换机的链路，则增加n条连接。

（与分组交换相比的）优点：

* 通信线路为通信双方用户专用，数据直达，传输数据时延非常小。

* 通信时有序传输，不存在失序问题。

* 不同的通信双方有不同的信道，不会产生冲突。

* 适用范围广，既适用于传输模拟信号，又适用于传输数字信号。

* 实时性强，通信双方之间的物理通路一旦建立，双方就可以随时通信。

* 控制简单

  电路交换的设备（交换机等）及控制均较简单。

（与分组交换相比的）缺点：

* 建立连接时间长

* 线路独占，使用率低

* 灵活性差

* 难以规格化

  电路交换时，数据直达，不同类型、不同规格、不同速率的终端很难相互进行通信，也难以在通信中进行差错控制。

##### （二）报文交换

报文是网络中交换与传输的数据单元，即站点一次性要发送的数据块。报文包含了将要发送的完整的数据信息，其长短很不一致，长度不限且可变。

报文交换在交换结点采用的是存储转发的传输方式。

报文交换主要使用在早期的电报通信网中，现在较少使用，通常被较先进的分组交换方式所取代。

##### （三）分组交换

分组交换在交换结点采用的是存储转发的传输方式，解决了报文交换中大报文传输的问题。

（与电路交换相比的）优点：

* 不需要为通信双方预先建立专用的通信信道，不存在连接建立时延。
* 通信双方不是固定占有一条通信线路，线路利用率高。
* 采用存储转发，交换节点具有路径选择，提高了传输的可靠性。

（与电路交换相比的）缺点：

* 存在传输时延。
* 需要传输额外的信息量。

分组交换根据其通信子网向端点系统提供的服务，还可进一步分为面向连接的虚电路方式和无连接的数据报方式。

|                    |                            数据报                            |                          虚电路                          |
| :----------------: | :----------------------------------------------------------: | :------------------------------------------------------: |
|     连接的建立     |                            不需要                            |                           需要                           |
|      目的地址      |                  每个分组都有完整的目的地址                  | 仅在建立连接阶段使用，之后每个分组使用长度较短的虚电路号 |
|      路由选择      |               每个分组独立地进行路由选择和转发               |          属于同一条虚电路的分组按照同一路由转发          |
|      分组顺序      |                     不保证分组的有序到达                     |                    保证分组的有序到达                    |
|       可靠性       |            不保证可靠通信，可靠性由用户主机来保证            |                    可靠性由网络来保证                    |
| 对网络故障的适应性 | 出故障的结点丢失分组，其他分组路径选择发生变化时可以正常传输 |          所有经过故障结点的虚电路均不能正常工作          |
|      拥塞控制      |                           很难实现                           |                         易于实现                         |

#### 六、计算机网络的功能

* 数据通信

  包括流量控制、路由选择、传输控制

  它是计算机网络最基本和最重要的功能

* 资源共享

* 分布式处理

  计算机网络使各计算机之间的联系更加紧密而非相对独立

* 提高可靠性

* 负载均衡

#### 七、计算机网络的性能指标

1kb = 10<sup>3</sup>bit	1Mb = 10<sup>6</sup>bit

##### （一）带宽（Bandwidth）

在计算机网络中，带宽表示网络的通信线路所能传送数据的能力，是数字信道所能传送的"最高数据传送速率"的同义语，单位是比特每秒（b/s）。

带宽指的是传输速率。

##### （二）时延（Delay）

时延指数据（一个报文或分组）从网络（或链路）的一端传送到另一端所需要的总时间。

时延由发送时延、传播时延、处理时延和排队时延四部分组成。

高速链路提高的仅是数据发送速率而非比特在链路上的传播速率。

* 发送时延

  结点将分组的所有比特推向（传输）链路所需的时间。

  发送时延受带宽的影响。

  发送时延 = 分组长度 / 信道宽度

* 传播时延

  电磁波在信道中传播一定距离需要花费的时间，即一个比特从链路的一端传播到另一端所需的时间。

  传播时延不受带宽的影响。

  电路交换，网络中的交换机不用进行存储转发，所以总的传输时延即为源端系统将数据传输到链路上的时间。

* 处理时延

* 排队时延

考虑从某源主机跨越一条固定路由向某目的主机发送一分组，变化的时延为排队时延，处理时延、传输时延和传播时延是固定的。
$$
\begin{aligned}
&采用分组交换方式，共有n个分组，长度为L比特，从源端系统到目的端系统，共有k段链路，每段链路的传播时延为d秒，传输速率为r比特/秒，\\
&每个分组交换机处理时延为h秒，忽略排队时延，则\\
&其传输时延t_1=(k+n-1)\frac{L}{r}，传播时延t_2=kd，处理时延t_3=(k-1)h，总时延t=t_1+t_2+t_3\\
&若只考虑发送时延和传播时延，且t_1>t_2，则在t_1时刻，第一个分组的第一个比特已经到达终点
\end{aligned}
$$

$$
\begin{aligned}
&假定有N个长为L的分组同时到达一条当前没有分组传输或排队的链路，链路传输速率为R。\\
&对N个分组而言，其平均排队时延t=\frac{0+\frac{L}{R}+\frac{2L}{R}+⋯+\frac{(n-1)L}{R}}{N}。
\end{aligned}
$$

$$
\begin{aligned}
&假定数据从服务器经过速率为R_sbps的第一段链路，经过路由器，再经过速率为R_cbps的链路可到达客户端。\\
&现在从服务器向客户发送两个分组，长度为L比特，两条链路的传播时延都为d_{prop}，R_c<R_s，且沿这条路径没有其他流量。\\
&如果服务器在发送第一个分组T秒之后再发送第二个分组。为确保在第二段链路之前没有排队，T必须要多长？\\
&从第一个分组第一个比特开始从服务器传输起计时，第一个分组完全达到客户端时间t_1=\frac{L}{R_s}+d_{prop}+\frac{L}{R_c}\\
&第二个分组将要达到第二段链路的时间t_2=\frac{L}{R_s}+T+\frac{L}{R_s}+d_{prop}\\
&由t_1≤t_2，得T≥\frac{L}{R_c}-\frac{L}{R_s}
\end{aligned}
$$

##### （三）时延带宽积

时延带宽积指发送端发送的第一个比特即将到达终点时，发送端已经发出了多少个比特，即链路上的最大比特数量，因此又称为以比特为单位的链路长度。

时延带宽积 = 传播时延 × 信道带宽

链路上的一个比特的宽度 = 传播速率 / 信道带宽
$$
\begin{aligned}
&假设主机A到主机B由一条长为2×10^7m远的R=1Gbps的链路直接相连，假定传播速率为2.5×10^8m/s。\\
&则时延带宽积=\frac{2×10^7}{2.5×10^8}×1×10^9bit=8×10^7bit\\
&考虑从主机A到主机B发送一个8×10^5比特的文件。假定该文件作为一个大的报文连续发送。则\\
&在任何给定的时间，在链路上具有的比特数据量最大值是8×10^5比特（不是8×10^7比特）。
\end{aligned}
$$

##### （四）往返时延（Round-Trip Time，RTT）

##### （五）吞吐量（Throughput）

吞吐量是指对网络、设备、端口、虚电路或其他设施，单位时间内成功地传送数据的数量。

在网络正常运行时，网络的吞吐量将随网络负载的增加而线性增加；网络拥塞使，网络额吞吐量随着负载的增加而不断下降。

吞吐量是瓶颈链路的传输速率。

<img src=".\picture\m对客户从服务器下载文件.png" alt="m对客户从服务器下载文件" style="zoom:50%;" />
$$
\begin{aligned}
&上图表示有m对客户-服务器在下载文件，R_s、R_c、R分别表示服务器链路、客户链路和（一条）网络链路的速率。\\
&假设所有其他链路都有充足容量，则其通用吞吐量表达式为\min\{R_s,R_c,\frac{R}{m}\}
\end{aligned}
$$

##### （六）速率（Speed）

##### （七）信道利用率

$$
\begin{aligned}
&信道利用率=\frac{传输帧的有效时间}{周期}=\frac{\frac{L}{C}}{ T} \\
&L:一个周期时间内发送的数据比特数（有些题目不考虑确认帧的长，但仍会考虑确认帧的传输和传播时延）\\
&C:发送方的信道传数速率\\
&T:发送周期=帧在发送端的传输时延+帧从发送端到接收端的传播时延+\\
&\hspace{0.75cm}确认帧在接收端的传输时延+确认帧从接收端到发送端的传播时延\\
&注意：信道利用率最大为1
\end{aligned}
$$

##### （八）信道吞吐率

$$
信道吞吐率=信道利用率×发送方的发送速率
$$

##### （九）流量强度

$$
\begin{aligned}
&假设分组到达队列的平均速率为a（单位为分组/秒，即pkt/s），传输速率为R（单位为bps）分组的比特大小为L，则\\
&流量强度I=\frac{La}{R}\\
&例如在瓶颈链路为15Mbps上进行每秒15次的请求，每次请求1Mb的内容，则I=\frac{15×1×10^6}{15×10^6}=1
\end{aligned}
$$

### 第二节 计算机网络的分层结构

网络模型分层目的：信息在网络中的传输非常复杂，分层是将复杂的问题简单化、局部化。可定义标准界面、提供标准语言、增加功能之间的独立性。

OSI参考模型：应用层、表示层、会话层、传输层、网络层、链路层、物理层。

因特网协议栈：应用层、运输层、网络层、链路层、物理层。

TCP/IP模型，即实际执行的国际标准：应用层、运输层、网际层、网络接口层。

在计算机网络体系结构的各个层次中，每个报文都分为两部分：一是数据部分，即SDU；二是控制信息部分，即PCI，它们共同组成PDU。

服务数据单元（SDU）：为完成用户所要求的功能而应传送的数据。
协议控制信息（PCI）：控制协议操作的信息。。
协议数据单元（PDU）：对等层次之间传送的数据单位称为该层的PDU。

#### 一、OSI参考模型中各层的简单概述

OSI参考模型比因特网协议栈中多了表示层、会话层，其他5层功能相同。

##### （一）应用层

应用层（application layer）的主要任务通过应用进程间的交互来完成特定的网络应用。

应用层提供的服务访问点是“用户界面”。

##### （二）表示层

表示层（presentation layer）的作用是使通信的应用程序能够解释交换数据的含义，提供数据压缩、数据加密和数据描述等服务。

#####  （三）会话层

会话层（session layer）提供了数据交换的定界和同步功能，包括了建立检查点和恢复方案的方法。

##### （二）传输层

传输层的（transport layer）主要任务是负责主机进程之间的通信，为端到端的连接提供流量控制、差错控制、拥塞控制、数据传输管理、多路复用及分解及UDP和TCP等服务。

传输层提供的是<u>端到端</u>的通信，是主机进程间的通信。

传输层的协议数据单元称为报文段。

应用层提供的服务访问点是“端口号”。

##### （三）网络层

网络层（network layer）的主要任务是把分组从源端传到目的端，提供流量控制、差错控制、路由选择、拥塞控制和网际互联等服务。

网络层提供主机之间的通信。

网络层的协议数据单元称为IP数据报(或简称为数据报、分组或包)。

应用层提供的服务访问点是“IP地址”。

##### （四）数据链路层

数据链路层（data link layer）的主要任务是将网络层的IP数据报组装成帧，提供流量控制、差错控制、成帧、物理寻址和数据重发等功能。

数据链路层提供的是<u>点到点</u>的通信。

数据链路层的协议数据单元称为帧。

应用层提供的服务访问点是“MAC地址（网卡地址）”。

##### （五）物理层

数据链路层（physical layer）的主要任务是传输比特流。

物理层的协议数据单元称为比特。

应用层提供的服务访问点是“网卡接口”。

#### 二、各层交互的封装过程

在发送主机端，一个应用层报文被传输到运输层。在最简单的情况下，运输层收取到报文并附上运输层首部信息，该首部将被接收端的运输层使用。应用层报文和运输层首部信息一起构成了运输层报文段。运输层报文段因此封装了应用层报文。应用层则向网络层传递该报文段，网络层增加了如源和目的端系统地址等网络层首部信息，生成了网络层数据报。该数据报接下来被传递给链路层，链路层增加它自己链路层首部信息并生成链路层帧。

#### 三、服务

服务是指在某一网络层次内完成的功能并能被高一层实体“看得见”的功能。服务是“垂直的”，而协议是“水平的”。

服务访问点（SAP）是指在同一个系统中相邻的两层的实体进行交互的地方。实际上是一个抽象的概念，一个逻辑接口。

上层使用下层所提供的服务时必须与下层交换一些命令，这些命令在OSI参考模型中称为服务原语。OSI参考模型将原语划分为四类：

* 请求

  由服务用户发往服务提供者，请求完成某项工作

* 指示

  由服务提供者发往服务用户，指示用户做某件事情

* 响应

  由服务用户发往服务提供者，作为对指示的响应

* 证实

  由服务提供者发往发往用户，作为对请求的证实

有应答服务包括四类原语，而无应答服务只有请求和指示两类原语。

## 第二章 应用层

因特网电话应用的开发者通常愿意将应用运行在UDP上，从而设法避开TCP的拥塞控制机制哈分组开销。但因为许多防火墙被配置成阻挡UDP流量，所以因特网电话应用通常设计成如果UDP通信失败就使用TCP作为备份。

|     应用     | 应用层协议 | 支撑的运输协议 | 端口 |
| :----------: | :--------: | :------------: | :--: |
|   电子邮件   |    SMTP    |      TCP       |  25  |
| 远程终端访问 |   Telent   |      TCP       |  23  |
|     Web      |    HTTP    |      TCP       |      |
|   文件传输   |    FTP     |      TCP       |      |
|  流式多媒体  |    HTTP    |      TCP       |  80  |
|  因特网电话  |  SIP、RTP  |    UDP或TCP    |      |

### 第一节 网络应用模型

⽹络体系结构是指将通信过程组织成多个层次，应用程序体系结构由应用程序研发这者设计，规定了如何在各种端系统上组织该应用程序。应用程序体系结构又称网络应用模型。

#### 一、客户/服务器模型

<img src=".\picture\CS模型.png" alt="CS模型" style="zoom:80%;" />

C/S模型中，有一个一直处于打开状态的服务器，等待客户机发过来的请求。

C/S模型的最重要的特征是：客户机请求服务，服务器提供服务。

客户程序必须知道服务器程序的地址，服务器程序不需要知道客户程序的地址。

常见的使用客户/服务器模型的应用包括Web、 文件传输协议（FTP）、远程登录和电子邮件等。

C/S模型特点：

* 网络中各计算机的地位不平等。服务器可以通过对用户权限的限制来达到管理客户机的目的，使它们不能随意存储/删除数据，或进行其他受限的网络活动。整个网络的管理工作由少数服务器担当，因此网络的管理非常集中。
* 客户机相互之间不直接通信。
* 可扩展性不佳。受服务器硬件和网络宽带的限制，服务器支持的客户机数有限。

#### 二、P2P模型

<img src=".\picture\P2P模型.png" alt="P2P模型" style="zoom:70%;" />

P2P模型中，不严格区分客户机和服务器，任何两台计算机都是对等方，直接可以相互通信。整个网络中的传输内容不再保存在中心服务器上，每个结点都同时具有下载、上传的功能，其权利和义务都是大体对等的。

P2P网络是指互联网中有对等结点组成的一种覆盖网络，是一种动态的逻辑网络。

与C/S模型相比，P2P模型的主要优点：

* 减轻了服务器的计算压力，消除了对某个服务器的完全依赖，可以将任务分配到各个结点上，因此大大提高了系统效率和资源利用率。

* 可扩展性好。传统服务器有响应和宽带的限制，因此只能接受一定数量的请求。
* 网络健壮性。单个结点的失效不会影响其他部分的结点。

缺点：在获取服务的同时，还要给其他结点提供服务，因此会占用较多的内存，影响整机速度。经常进行P2P下载还会硬盘造成较大损伤。
$$
\begin{aligned}
&若向N个对等方分发F比特的文件。该服务器具有u_sbps的上传速率，每个对等方的下载速率为d_ibps，上传速率为u。\\
&请分别针对客户-服务器分发模式和P2P分发模式两种情况，求出最小分发时间。\\
&C/S模式下，最小分发时间D_{cs} = max \{\frac{NF}{u_s}, \frac{F}{d_{min}}\}\\
&P2P模式下，最小分发时间D_{p2p} = max \{\frac{F}{u_s}, \frac{F}{d_{min}},\frac{NF}{u_s+\sum_{i=1}^N{u_i}}\}\\
&（C/S模式下，服务器的上传完N个文件时间为\frac{NF}{u_s}，各客户端下载完成的时间为\frac{F}{d_{min}}）\\
&（P2P模式下，服务器上传一个文件时间\frac{F}{u_s}，各客户端下载完成的时间\frac{F}{d_{min}}，15个文件由1+N台主机来分发的时间\frac{NF}{u_s+\sum_{i=1}^N{u_i}}）\\
\end{aligned}
$$

$$
\begin{aligned}
&考虑在一个有N个活跃对等方的覆盖网络中，每对等方有一条活跃的TCP连接。此外该TCP连接通过总共M台路由器。\\
&在对应的覆盖网络中，有多少结点和边。\\
&有N个结点，\frac{N·(N-1)}{2}条边\\
\end{aligned}
$$



### 第二节 域名系统

域名系统（Domain Name System，DNS）是因特网使用的命名系统，用来把便于人们记忆的具有特定含义的主机名转换为便于机器处理的IP地址。

DNS是一个分布式、层次数据库。

DNS系统采用客户/服务器模型，其协议运行在<u>UDP</u>之上，使用<u>53</u>号端口。

从概念上可将DNS分为层次域名空间、域名服务器和解析器。

#### 一、层次域名空间

域名是采用层次树状的命名方法。

域名中的标号：

* 标号中的英文不区分大小写
* 标号中除连字符(-)外不能使用其他的标点符号
* 每个标号不能超过63各字符，多标号组成的完整域名最长不能超过255个字符

注意：域名与IP地址、MAC地址或主机都不存在一一对应的关系

#### 二、域名服务器

##### （一）根域名服务器

因特网上有13个根域名服务器。

##### （二）顶级域名服务器

##### （三）授权域名服务器（权限域名服务器）

每台主机都必须在授权域名服务器处登记。

许多域名服务器同时充当本地域名服务器和权威域名服务器。

##### （四）本地域名服务器

#### 三、域名解析过程

当客户端需要域名解析时，通过本机的DNS客户端构成一个DNS请求报文，以UDP数据报方式发往本地域名服务器。

本地域名服务器提供递归查询服务，其他域名服务器提供迭代查询服务。

局域网内的主机A通过超链接`http://www.abc.com`访问因特网请求浏览纯文本Web页，其域名解析过程、所需RTT（局域网内访问因特网上各个服务器的往返时间，忽略其他时延）、UDP报文个数：

* 本地主机有该域名到IP地址的记录，不需要DNS查询。（0RTT、0UDP）
* 若本地主机上没有相应的记录，则本机主机递归查询本地域名服务器，若查询到相应的记录，将结果返回给本地服务器。（1+2RTT、2UDP）
* 若本地域名服务器没有相应的记录，则依次迭代查询根域名服务器、`com`顶级域名服务器、`abc.com`域名服务器，查询到IP地址后，将该映射返回给本地域名服务器，由本地域名服务器返回给主机A。（3+2RTT、8UDP）
* 和目标服务器建立TCP连接，接着发送访问请求并收到服务器资源响应。（2RTT）

在交互中，使用UDP需要消耗1个RTT时间，而TCP需要2个RTT时间。

### 第三节 文件传输协议

文件传输协议（File Transfer Protocol，FTP）采用C/S的工作方式，在运输层采用TCP协议，在网络层采用IP协议。

匿名FTP访问通常使用 anonymous 作为用户名。

#### 一、FTP的工作原理

FTP的服务器进程由两大部分组成：一个是主进程，负载接受新的请求；若干从属进程，负责处理单个请求。

FTP提供交互式的访问，允许客户殖民文件的类型与格式，并允许文件具有存取权限。

主要工作过程：在进行文件传输时，FTP客户所发出的传送请求通过控制连接发送给服务器端的控制进程，并在整个会话期间一直保持打开，但控制连接不用来传送文件。服务器端的控制进程在接收到FTP客户发送来的文件传输请求后，就创建数据传送进程和数据连接，数据连接用来连接客户端和服务器端的数据传输进程，数据传送进程实际完成对文件的传送，在传送完毕后关闭"数据传送连接"，并结束运行。

#### 二、控制连接与数据连接

##### （一）控制连接

服务器监听21号端口，等待客户连接，建立在这个端口上的连接称为控制连接。

由于FTP传输控制信息使用的是数据连接外的控制连接，所以也称FTP的控制信息是带外传送的。

##### （二）数据连接

数据连接有两种传输模式：

* 主动模式PORT

  客户端连接到服务器的21号端口，登录成功后要读取数据时，客户端随机开放一个端口，并发送PORT命令告知服务器，服务器收到命令和端口号后，通过20端口和客户端开发的端口连接，发送数据。

  传输数据是服务器连接到客户端的端口。

* 被动模式PASV

  客户端要读取数据时，发送PASV命令到服务器，服务器在本地随机开放一个端口并告知客户端，客户端在连接到服务器开放的端口进行数据传输。

  传输数据是客户端连接到服务器的端口。

### 第四节 电子邮件

电子邮件是一种异步通信方式，通信时不需要双方同时在场。

#### 一、电子邮件系统的组成结构

电子邮件系统的三个最主要的组成构件：

* 用户代理（User Agent，UA）

  用户代理向用户提供一个接口，用来发送和接受邮件。通常情况下，用户代理就是一个运行在PC上的程序。

* 邮件服务器（Mail Server）

  邮件服务器的功能是发送和接受邮件，同时还要向发信人报告邮件传送的情况。

  邮件服务器采用客户/服务器方式工作，但它必须能够同时充当客户和服务器。

* 简单邮件传输协议（Simple Mail Transfer Protocol，SMTP）

  邮件发送协议用于用户代理向邮件服务器发送邮件或在邮件服务器之间发送邮件，如SMTP

  邮件读取协议用于用户代理从邮件服务器读取邮件，如POP3、IMAP

#### 二、邮件收发过程

①发信人调用用户代理来撰写和编辑要发送的邮件。用户代理用SMTP把邮件发送给发送端邮件服务器。

②发送端邮件服务器将邮件放入邮件缓存队列中，等待发送。

③运行在发送端邮件服务器的SMTP客户进程，发现邮件缓存中有待发送的邮件，就向运行在接收端邮件服务器的SMTP服务器进程发起TCP连接。

④TCP连接建立后，SMTP客户进程开始向远程SMTP服务器进程发送邮件。

⑤当所有待发送邮件发完后，SMTP就关闭所建立的TCP连接。

⑥收信人打算收信时，调用用户代理使用<u>POP3或IMAP</u>协议将自己的邮件从接收邮件服务器的用户邮箱中拉取。

#### 三、电子邮件协议

##### （一）简单邮件传输协议

简单邮件传输协议（Simple Mail Transfer Protocol，SMTP）是一种提供可靠且有效的电子邮件传输的协议。

SMTP使用客户/服务器方式，其协议运行在TCP之上，使用25号端口。

SMTP只支持传输7比特ASCII码内容，且无法传送可执行文件及其他二进制对象。

用户浏览器（如Firefox）与邮件服务器（如Hotmail或Gmail）之间的邮件发送或接收使用的是HTTP，而仅在不同邮件服务器之间传送邮件时才使用SMTP。

##### （二）多用途因特网邮件扩展

多用途因特网邮件扩展（Multipurpose Internet mail Extensions，MIME）并未改动SMTP或取代它。定义了传送非ASCII码的编码标准。

##### （三）邮局协议

邮局协议（Post Office Protocol，POP）是一个非常简单但功能有限的邮件读取协议，现在使用的是它的第三版本POP3。

POP使用客户/服务器方式，其协议运行在TCP之上，使用110号端口。

POP3协议在运输层是使用明文来传输密码的，并不对密码进行加密。

##### （四）因特网报文存取协议

因特网报文存取协议（Internet Message Access Protocol）是另一个邮件读取协议，比POP复杂得多。

#### 四、电子邮件格式

一个电子邮件分为信封和内容两大部分，邮件内容又分为首部和主题两部分。

### 第五节 万维网

#### 一、万维网的概念与组成结构

万维网（World Wide Web，WWW）是一个分布式、联机式的信息存储空间。万维网是无数个网络站点和网页的集合，它们在一起构成的因特网最主要的部分。

万维网的内核由三个标准构成：

* 统一资源定位符（URL）
* 超文本传输协议（HTTP）
* 超文本标记语言（HTML）

#### 二、超文本传输协议

超文本传输协议（HyperText Transfer Protocol，HTTP）是面向事务的应用层协议，它规定了在浏览器和服务器之间的请求和响应的格式与规则，是万维网上能够可靠地交换文件的重要基础。

##### （一）HTTP的操作过程

每个万维网站点都有一个服务器进程，它不断地监听TCP的端口，默认为80，当监听到连接请求后便与浏览器建立TCP连接。然后，浏览器就向服务器发送请求获取某个Web页面的HTTP请求。服务器收到请求后，将构建所请求Web页的必须信息，并通过HTTP响应返回给浏览器。浏览器再将信息进行解释，然后将Web页显示给用户。最后TCP连接释放。

##### （二）HTTP的特点

HTTP作为运输层协议，使用TCP。

HTTP本身是无连接的，虽然HTTP使用了TCP连接，但通信双方在交换HTTP报文之前不需要先建立HTTP连接。

每个请求及其响应是经一个单独的TCP连接发送称为非持续连接。所有的请求及其响应经相同的TCP连接发送称为持续连接。HTTP既可以持续连接也可以使用非持续连接。

对于非持久连接，每个网页对象（如JPEG图形）的传输都需要单独建立一个TCP连接，每个对象引用都导致2×RTT的开销（一个用于TCP连接，另一个RTT用于请求和接收文档），此外每次建立新的TCP连接都要分配缓存和变量，使万维网的负担变重。

持久连接又分为非流水线和流水线方式：

* 非流水线方式

  客户在收到前一个响应后才能发出下一个请求，每个引用对象经历1个RTT延迟，服务器发送完一个对象后，其TCP连接就处于空闲状态，浪费了服务器资源。

* 流水线方式

  客户每遇到一个对象引用就立即发出一个请求，所有引用对象共计经历一个RTT延迟。

$$
\begin{aligned}
&假定用户通过某超链接访问在某一台服务器上的某HTML文件，且该HTML引用了8个非常小的对象。\\
&若DNS产生的RTT总计为t_{DNS}，令RTT_0表示本地主机和包含对象的服务器之间的RTT值。\\
&则从用户点击超链接到它接收到该对象的时间：\\
&没有并行连接的非持续HTTP:t_{DNS}+2RTT_0+16RTT_0\\
&配置5个并行连接的非持续HTTP:t_{DNS}+2RTT_0+4RTT_0\\
&没有并行连接的非流水线方式的持续HTTP:t_{DNS}+2RTT_0+8RTT_0\\
&没有并行连接的流水线方式的持续HTTP:t_{DNS}+2RTT_0+1RTT_0
\end{aligned}
$$

$$
\begin{aligned}
&假定包含数据的分组是100000比特长，仅包含控制（如ACK或握手）的分组是200比特长。\\
&考虑一条10米短链路，某发送方经过它能够以150bps速率双向传输。假定N个并行连接每个都获得1/N的链路带宽。\\
&现在考虑HTTP协议，并且假定每个下载对象是100Kb长，这些初始下载对象包含10个来自相同发送方的引用对象。\\
&令Tp表示客户端和服务器之间的单向传播延迟，给出非持久连接的并行下载时间与持久连接非流水线下载时间。\\
&解：\\
&非持久连接的并行下载时间：3(\frac{200}{150}+Tp)+\frac{100000}{150}+Tp+3(\frac{200}{15}+Tp)+\frac{100000}{15}+Tp\\
&持久连接非流水线下载时间：3(\frac{200}{150}+Tp)+\frac{100000}{150}+Tp+10(\frac{200}{150}+Tp+\frac{100000}{150}+Tp)
\end{aligned}
$$

##### （三）HTTP的报文结构 

有两类HTTP报文：请求报文和响应报文。

<img src=".\picture\HTTP报文格式.png" alt="HTTP报文格式" style="zoom:80%;" />

HTTP请求报文和响应报文都由开始行、首部行、实体主体三个部分组成。这两种报文格式的区别就是开始行不同。

* 开始行

  在请求报文中的开始行称为请求行，在响应报文中开始行称为状态行。

* 首部行

  `Connection`字段决定了客户端和服务器进行了一次会话后，服务器是否立即关闭网络连接，值可以为`close`表示短连接（非持续连接）和`keep-alive`表示长连接（持续连接）。

  响应报文的`Date`字段表示服务器产生并且发送该响应报文的日期和时间。

  响应报文的`Content-Length`字段表示响应报文的字节数。

* 实体体（实体主体）

  在请求报文中一般不用这个字段，在响应报文中也可能没有这个字段。

请求报文和响应报文成对出现。例如：假设用户请求由某些文本和两幅图片组成的Web页面，对于这个页面，客户机将发送三个请求报文并接收三个响应报文。

响应报文的状态码：

| 状态码 |                         状态描述说明                         |
| :----: | :----------------------------------------------------------: |
|  200   |              请求成功，信息在返回的响应报文中。              |
|  301   | 请求对象已经永久转移了，新的URL定义在响应报文的Location首部行中。客户软件将自动获取新的URL。 |
|  400   |       一个通用差错代码，指示该请求不能被服务器所理解。       |
|  403   |              服务器收到了请求，但拒绝提供服务。              |
|  404   |                       请求资源不存在。                       |
|  405   |                      请求的方法不允许。                      |
|  500   |                  服务器发生不可预期的错误。                  |
|  503   |    服务器当前不能处理客户端的请求，一段时间后可能回复正常    |
|  505   |           服务器不支持请求报文使用的HTTP协议版本。           |

## 第三章 传输层

### 第一节 传输层提供的方服

#### 一、传输层的功能

功能：

* 传输层提供应用进程之间的逻辑通信（即端到端的通信）

  与网络层的区别是，网络层提供的是主机之间的逻辑通信。

* 多路复用和分解

  多路复用指在源主机从不同套接字中手机数据块，并为每个数据块封装上首部信息从而生成报文端，然后将报文段传递给网络层。

  多路分解指将传输层报文段中的数据交付到正确的套接字的工作。

* 对收到的报文进行差错检测（首部和数据部分）

  网络层只检查IP数据报的首部，不检查数据部分是否出错。

* 提供两种不同的传输协议，即TCP与UDP

  在网络层要么只提供面向连接的服务，如虚电路；要么只提供无连接的服务，如数据报，而不可能在网络层同时存在这两种方式。

#### 二、传输层的寻址与端口

##### （一）端口的作用

端口能够让应用层的各种应用进程将其数据通过端口向下交付给传输层，以及让传输层知道应当将其报文段中的数据向上通过端口交付给应用层相应的进程。

端口是传输层服务访问点（TSAP）。

数据链路层的SAP是MAC地址，网络层的SAP是IP地址，传输层的SAP是端口。

##### （二）端口号

端口号长度为16bit。

##### （三）套接字

在网络中通过IP地址来标识和区别不同的主机，通过端口号来标识和区分一台主机中的不同应用程序，端口号拼接到IP地址即构成套接字Socket（IP+端口号，包括源IP、目的IP、源端口、目的端口）。套接字实际上是一个通信端点。

进程通过一个称为套接字的软件接口向网络发送报文和从网络接收报文。

应用程序开发者对于运输成的控制仅限于：

* 选择运输层协议
* 也许能设定几个运输层参数，如最大缓存和最大报文段长度等

#### 三、无连接与面向连接服务

面向连接服务就是通信双方进行通信之前必须先建立连接，在通信过程中，整个连接的情况一直被实时地监控和管理。通信结束后，释放连接。

无连接服务是指两个实体之间的通信不需要先建立好连接，需要发送数据时可直接发送，直接把信息发送到“网络”中，让该信息的传递在网上经历而为地往目的地传送。

无连接的服务的信道利用率比面向连接的服务高。无连接的服务可以动态分配带宽。无连接的服务适合短报文的运输。

对于可靠的面向连接的服务：在报文流中，网络保持对报文边界的跟踪；而在字节流中，网络不作这样的跟踪。

TCP/IP（Transmission Control Protocol/Internet Protocol，传输控制协议/网际协议）是指能够在多个不同网络间实现信息传输的协议簇。TCP/IP协议不仅仅指的是TCP和IP两个协议，而是指一个由FTP、SMTP、TCP、UDP、IP等协议构成的协议簇， 只是因为在TCP/IP协议中TCP协议和IP协议最具代表性，所以被称为TCP/IP协议。

IP数据报在网络成要经过路由的存储转发。

UDP数据报在传输层的端到端的逻辑信道中传输，封装成IP数据报在网络层传输。

连接是建立在确认机制的基础之上的。所以不存在无确认的有连接的服务。

### 第二节 UDP协议

#### 一、UDP数据报

##### （一）UDP概述

UDP本身虽然不能可靠传输，但可以在应用程序自身中建立可靠性机制，如增加确认和重传机制来让应用程序得到可靠数据传输。

##### （二）UDP首部格式

UDP首部有8B，由4个字段组成，每个字段的长度都是2B。

<img src=".\picture\UDP首部.png" alt="UDP首部" style="zoom:80%;" />

各字段意义：

* 源端口

  在需要对方回信时选用，不需要时可用全0。

* 目的端口

  这在终点交付报文时必须使用到。

  如果接收方UDP发现收到的报文中的目的端口不存在对应于端口号的应用进程，那么就丢弃报文，并由ICMP发送“端口不可达”差错报文给发送方。

* 长度

  UDP数据报的长度，其最小值为8。

* 校验和

  UDP校验和不是必需的，如果不使用校验和，那么将校验和字段设置为0。

#### 二、UDP校验和

UDP校验和的计算方法是二进制反码运算求和再取反。使用反码可不依赖系统是大端小端，便于接收方检测错误。

在计算校验和时，要在UDP数据报之前增加12B的伪首部，伪首部并不是UDP的真正首部。只是在计算校验和时，临时添加在UDP数据报的前面，得到一个临时的UDP数据报。伪首部既不向下传送又不向上递交，而只是为了计算校验和。

伪首部包括IP分组报头的一部分。通过伪首部，不仅可以检查源端口号、目的端口号和UDP用户数据报的数据部分，还可以检查IP数据报的源IP地址和目的地址。

若UDP数据报的数据部分不是偶数个字节，则要在数据部分末尾填入一个全零字节，但该字节不发送。

<img src=".\picture\UDP伪首部.png" alt="UDP伪首部" style="zoom:80%;" />

<img src=".\picture\UDP校验和.png" alt="UDP校验和" style="zoom:80%;" />

如果UDP校验出UDP数据报是错误的，那么可以丢弃，也可以交付给上层，但是需要附上错误报告，即告诉上层这是错误的数据报。

### 第三节 TCP协议

最大报文段长度（Maximun Segment Size，MSS）通常根据最初确定的有本地发送主机的最大链路层帧长度（即所谓的最大传输单元(Maximum Transmission Unit，MTU)）来设置。设置该MSS要保证一个TCP报文段加上TCP/IP首部长度将适合单个链路层帧。以太网和PPP链路层协议都具有1500字节的MTU，因此MSS的典型值为1460字节。

#### 一、TCP协议的特点

TCP是在⽹络层之上实现的可靠的数据传输协议，它主要解决传输的可靠、有序、无丢失和不重复问题。

TCP套接字是由一个四元组（源IP地址、源端口号、目的IP地址、目的端口号）来标识的。

* 每条TCP连接只能有两个端点，每条TCP连接只能是端到端的

* TCP是面向字节流的

  虽然应用程序和TCP的交互是一次一个数据块，但TCP把应用程序交下来的数据仅视为一连串的无结构的字节流。

* TCP提供全双工通信，允许通信双方的应用进程在任何时候都能发送数据，为此TCP连接的两端都设有发送缓存和接收缓存。

  发送缓存用来暂时存放以下数据：

  * 发送应用程序传送给发送方TCP准备发送的数据
  * TCP已发送但尚未收到确认的数据

  接收缓存用来暂时存放以下数据：

  * 按序到达但尚未被接收应用程序读取的数据
  * 不按序到达的数据

TCP报文长度根据接收方给出的窗口之和当前网络拥塞程度来决定。

#### 二、TCP报文段

<img src=".\picture\TCP首部.png" alt="TCP首部" style="zoom:60%;" />

各字段意义：

* 序号

  接收方可以通过序号来确定新到达的报文段是新的还是重发的。

  注意：TCP连接传送的数据流中的每个字节都会编上一个序号，但一个报文段的序号应该是该报文段首个字节的编号。

* 确认号

  期望收到对方下一个报文段的第一个数据字节的序号。

* 数据偏移

  标识首部长度，它指出TCP报文段的数据起始处距离TCP报文段的起始处有多远。单位：4B。TCP首部的最大长度为60B

* 紧急位URG

* 确认位ACK

  仅当ACK=1时确认号字段才有效

* 推送位PSH

* 复位位RST

* 同步位SYN

  当SYN=1时表示这是一个连接请求或连接接收报文

* 终止位FIN

  当FIN=1时，表示此报文段的发送方的数据已发送完毕，并要求释放运输连接

* 窗口

  它指出现在允许对方发送的数据量，接收方的数据缓存空间是有限的，因此用窗口值作为让发送方设置其发送窗口的依据

* 校验和

  校验和字段检验的范围包括首部和数据两部分

TCP报文长度根据接收方给出的窗口之和当前网络拥塞程度来决定。


$$
\begin{aligned}
&描述应用程序开发者为什么可能选择在UDP上运行应用程序而不是经UDP发送。\\
&答：如果该应用程序开发者不需要TCP提供的流量控制和拥塞控制，注重数据的网络传输效率，且允许数据出现小部分的丢失，那么该应用程序开发者就可能选择UDP而不是TCP。
\end{aligned}
$$

例题：一个UDP用户数据报的数据字段为8192B，要使用以太网来传送。假定IP数据报无选项。试问应当划分为几个IP数据报片？说明每个IP数据报片的数据字段程度、片段偏移和MF标志的值。

解：UDP用户数据报的数据字段为8192B，加上8B的首部，所以IP数据部分总长度为8200B。IP数据报首部长度为20B，而以太网帧的数据段的最大长度是1500B，1480B的数据部分和20B的IP首部，由1480n≥8200，所以应当划分为6个IP报片。而片偏移的单位是8B。

|              |   1   |   2   |   3   |   4   |   5   |  6   |
| :----------: | :---: | :---: | :---: | :---: | :---: | :--: |
| IP报片总长度 | 1500B | 1500B | 1500B | 1500B | 1500B | 820B |
|   数据偏移   | 1480B | 1480B | 1480B | 1480B | 1480B | 800B |
|    片偏移    |   0   |  185  |  370  |  555  |  740  | 925  |
|      MF      |   1   |   1   |   1   |   1   |   1   |  0   |

#### 三、TCP连接管理

每个TCP连接都有三个阶段：连接建立、数据传送和连接释放。

TCP连接的建立采用客户/服务器模式。 

##### （一）TCP连接建立

连接的建立经历以下三个步骤，通常称为三次握手：

* 第一步：客户机的TCP首先向服务器的TCP发送连接请求报文段

  此时，TCP客户进程进入SYN-SENT（同步已发送）状态。

  该报文段的首部中的同步位SYN置1。

  该报文段不能携带数据。在选择一个作为客户机的报文段的初始序号seq=x后，会消耗掉该序号。

* 第二步：服务器的TCP收到连接请求报文段后，如统一建立连接，则向客户机发回确认，并为该TCP连接分配缓存和变量。

  此时，TCP服务器进程进入SYN-RCVD（同步收到）状态。

  该确认报文段中，SYN位和ACK位都置1。

  该报文段不能携带数据。在选择一个作为服务器的报文段的初始序号seq=y后，会消耗掉该序号。

* 第三步：当客户机收到确认报文段后，还要向服务器给出确认，并为该TCP连接分配缓存和变量。

  此时，TCP客户进程进入ESTABLISHED（已建立连接）状态。

  该报文段可以携带数据，若不携带数据则不消耗序号。

  该报文段的首部中的确认位ACK置1。

  该报文段的确认号ack=y+1，序号seq=x+1。

服务器端的资源是在完成第二次握手时分配的，而客户端的资源是在完成第三次握手时分配的，这使得服务器易于收到SYN泛洪攻击。

对于诸如搜索、电子邮件和社交网络等云服务，非常希望提供高水平的响应性，给用户一种完美的印象，即这些服务正在运行在它们自己的端系统中。因为用户经常位于远离数据中心的地方，而这些数据中心负责为云服务的动态内容提供服务。若端系统远离数据中心，则RTT一般将会很大，会由于慢启动潜在地导致低劣的响应时间性能。通常，服务器在慢启动期间交付响应要求三个TCP窗口。所以从某端系统发起一条TCP连接到它收到该响应的最后一个分组的时间粗略是4RTT（建立TCP连接的RTT加上用于3个数据窗口的3个RTT），再加上在数据中心中处理的时间，时延会比较大。缓解这个问题的方法是部署邻接用户的前端服务器并在该前端服务器利用TCP分岔来分裂TCP连接，响应时间大致变为4TCP<sub>FE</sub>+TCP<sub>BE</sub>+处理时间（其中TCP<sub>FE</sub>微不足道，往返时延也就约为RTT了 ）。

##### （二）TCP连接的释放

TCP连接释放的过程通常称为四次握手：

* 第一步：客户机打算关闭连接时，向其TCP发送连接释放报文段，并停止发送数据，并主动关闭TCP连接。

  客户机进程进入FIN-WAIT-1（终止等待1）状态。

  终止位FIN=1。

  序号seq=u，它等于前面已传送的数据的最后一个字节的序号加1。

  该报文可以携带数据。若不携带数据会消耗掉一个序号。

* 第二步：服务器收到连接释放报文段后立即发出确认。

  服务器进入CLOSE_WAIT状态。

  确认位ACK=1。

  序号seq=v，它等于前面已传送的数据的最后一个字节的序号加1。确认号ack=u。

  此时，从客户机到服务器这个方向的连接就释放了，TCP连接处于半关闭状态。

* 第三步：若服务器已经没有要向客户机发送的数据时，就通知TCP释放连接。

  这是服务器进入LAST-ACK（最后确认）状态。

  终止位FIN=1，确认位ACK=1。

  序号seq=w，它等于第一步中已传送的数据的最后一个字节的序号加1。确认号ack=u+1，重复上次已发送的确认号。

* 第四步：客户机收到连接释放报文段后，必须发出确认。

  此时TCP连接还未释放，客户的TCP状态为TIME_WAIT。

  确认位ACK=1。序号seq=u+1，确认号ack=w+1。

  在经过2MSL（最大报文段寿命）后，客户机才进入CLOSED（连接关闭）状态。

#### 四、往返时间的估计与超时

EstimatedRTT是SampleRTT的加权平均值，这个加权平均值对最近的样本赋予的权值要大于对旧样本赋予的权值。

DevRTT表示RTT偏差，用于估算SampleRTT一般会偏离EstimatedRTT的程度。

超时间隔TimeoutInterval = EstimatedRTT + 4·DevRTT

#### 五、TCP可靠传输

TCP的任务是在IP层不可靠的、尽力而为服务的基础上建立一种可靠数据传输服务。

如果在因特网中的所有链路都提供可靠的交付服务，TCP可靠传输服务将是多余的吗？为什么？
尽管每个连接都保证通过连接发送的IP数据报将在连接的另一端收到而不出现错误，但是不能保证IP数据报将以正确的顺序到达最终目的地。使用IP，同一TCP连接中的数据报可以采用网络中的不同路由，因此顺序可能混乱，仍然需要TCP以正确的顺序为应用程序的接收端提供字节流。而且，由于路由环路或设备故障，IP可能会丢失数据包。

##### （一）序号

TCP连接传送的数据流中的每个字节都编上一个序号。

##### （二）确认

TCP默认使用累积确认。TCP对每个字节编号，但并不是接收到每个字节都要发回确认，而是在发送一个报文段的字节后才发回一个确认，所以TCP采用的是对报文段的确认机制。

例如确认号是500，表示已经收到499字节的数据。

##### （三）重传

有两种事件会导致TCP对报文段进行重传：超时和冗余ACK。

* 超时

  TCP每发送一个报文段，就对这个报文段设置一次计时器。计时器设置的重传时间到期但还未收到确认时，就要重传这一报文段。

* 冗余ACK（冗余确认、快速重传）

  TCP规定每当比期望序号大的失序报文段到达时，就发送一个冗余ACK，指明下一个期待字节的序号。当发送方收到对同一个报文段的3个冗余ACK时，就可以认为跟在这个被确认报文段之后的报文段已经丢失，发送方会立即重传接收方所期待的报文。
  
  注意：SR和GBN只有超时重传，没有快速重传。

TCP收到失序报文的处理没有规定，由实现TCP的编程人员去处理。

##### （四）校验

TCP的校验机制与UDP校验一样。

#### 六、TCP流量控制和拥塞控制

TCP提供流量控制服务来消除发送方发送速率太快使接收方缓存区溢出的可能性。

传输层和数据链路层的流量控制的区别：1.传输层定义端到端用户之间的流量控制，数据链路层定义两个中间的相邻结点的流量控制。2.数据链路层的滑动窗口协议的窗口大小不能动态变化，传输层则可以动态变化。

拥塞控制是指防止过多的数据注入网络，保证网络中的路由器或链路不致过载。

当数据传输速率的总和大于某条链路的容量时，就需要进拥塞控制。例如一百台主机以1Gb/s的速率向链路传输数据，而链路只有10Gb/s的速率，则会造成拥塞。

拥塞控制与流量控制的区别：拥塞控制是让网络能够承受现有的网络负荷，是一个全局性的过程，涉及所有的主机、路由器，以及与降低网络传输性能有关的所有因素。而流量控制往往指点对点的通信量的控制，是端到端的问题，它所要做的是抑制发送端发送数据的速率，以便使接收端来得及接收。

拥塞控制策略：

* 开环控制（静态）

  在设计网络时事先将有关发生拥塞的因素考虑周到，力求网络在工作时不产生拥塞。一旦整个系统启动并运行，中途就不再需要修改。

* 闭环控制（动态）

  事先不考虑有关发生拥塞的各种因素，才监测网络系统区监视，及时检测哪里发生了拥塞，然后将拥塞信息传到合适的地方，以便调整网络系统的运行，并解决出现的问题。

TCP协议要求发送方维护两个窗口：

* 接收窗口 （receive window，rwnd）

  接收方根据目前接收缓存大小所许诺的最新窗口值，反映接收方的容量。

  由接收方根据其放在TCP报文的首部的窗口字段通知发送方。

* 拥塞窗口 （congestion window，cwnd）

  发送方根据自己估算的网络拥塞程度而设置的窗口值，反映网络的当前容量。

接收方的缓存空间是有限的，因此发送发送窗口的实际大小由流量控制和拥塞控制共同决定。

针对`TCP Reno`介绍慢启动、拥塞避免与快速恢复。

##### （一）慢启动

* 在TCP刚刚连接好并开始发送TCP报文段时，先令拥塞窗口cwnd=1（目的是试探网络的拥塞情况），即一个最大报文段长度MSS。

* 之后每收到一个对新报文段的确认后，将cwnd加1，即增大一个MSS（相当于每隔一个RTT时间，报文段发送数量增加一倍，cwnd也增加一倍）。

* 当cwnd增大到慢启动阈值（slow start threshold，ssthresh）时，然后改用拥塞控制算法。

* 若2cwnd>ssthresh，则下一个RTT后的cwnd等于ssthresh，而不等于2cwnd。

* 若收到3个冗余ACK，则ssthresh变为原来cwnd的一半（向下取整），cwnd变为原来的一半（向下取整）+3。

  cwnd变为原来的一半（向下取整）+3该方式为计网黑书上的计算方式，有些参考书不采用加3，做题时稍微判断下。

$$
\begin{aligned}
&在这个习题中，我们考虑由 TCP 慢启动阶段引入的时延。考虑一个客户和一个 Web 服务器直接连接到速率为 R 的一条链路。\\
&假定该客户要取回一个对象，其长度正好等于 15 S，其中 S 是最大报文段长度(MSS)。客户和服务器之间的往返时间表示为 RTT（假设为常数）。\\
&忽略协议首部，确定在下列情况下取回该对象的时间（包括 TCP 连接创建）：\\
&a）\frac{4S}{R}> S/R + RTT > \frac{2S}{R}\\
&b）\frac{S}{R} + RTT > \frac{4S}{R}\\
&c）\frac{S}{R} > RTT\\
\end{aligned}
$$

$$
\begin{aligned}
&（首先由于分组是等待确认后才会发送新的分组，需要判断一个RTT下可以发送多少个分组。）\\
&a:由RTT > \frac{S}{R}，说明往返时延小于传输时延，在一个RTT下至少能发送1个分组。\\
&记服务端传输完第一个分组的时间为t_0\\
&服务端接收到第一个分组的ack并开始传输第二分组的时间t_1=RTT+t_0\\
&服务端传输完第二分组并开始传输第三分组的时间t_2=t_1+\frac{S}{R}=RTT+\frac{S}{R}+t_0\\
&服务端接收到第二分组的ack并开始传输第四分组的时间t_3=t_2+RTT=2RTT+\frac{S}{R}+t_0\\
&服务端接收到第三分组的ack并开始传输第五分组的时间t_4=t_3+\frac{S}{R}=2RTT+\frac{2S}{R}+t_0\\
&由\frac{3S}{R}>RTT，知传输三个分组的时间大于一个RTT，所以在连续传输完第五、第六、第七分组之前第四分组的ack已经到达。\\
&所以可以连续传输第五至第十五，共十一个分组。\\
&服务端传输传输完第第十五分组的时间t_5=t_4+\frac{11S}{R}+RTT=3RTT+\frac{13S}{R}+t_0\\
&客户端接收完第十五分组所需的总时间t=3RTT+\frac{13S}{R}+2RTT+\frac{S}{R}=5RTT+\frac{12S}{R}
\end{aligned}
$$

$$
\begin{aligned}
&b:\\
&记服务端传输完第一个分组的时间为t_0\\
&服务端接收到第一个分组的ack并开始传输第二分组的时间t_1=RTT+t_0\\
&服务端传输完第二分组并开始传输第三分组的时间t_2=t_1+\frac{S}{R}=RTT+\frac{S}{R}+t_0\\
&服务端接收到第二分组的ack并开始传输第四分组的时间t_3=t_2+RTT=2RTT+\frac{S}{R}+t_0\\
&服务端接收到第三分组的ack并开始传输第五分组的时间t_4=t_3+\frac{S}{R}=2RTT+\frac{2S}{R}+t_0\\
&t_4时刻，窗口大小为4，且有三空闲，可连续传输第五至第七分组。\\
&由RTT > \frac{3S}{R}，知在连续传输完第五、第六、第七分组时第四分组的ack不会到达，不会立即传输第八分组。\\
&第四分组的ack达到服务器时，由于第四、第五、第六、第七分组是连续发送，之后其ack会连续到达。\\
&（第四分组的ack达到服务器时，窗口大小增大为5，且有二空闲，立即连续发送第八分组）。\\
&服务端接收第四分组的ack并开始传输第八分组的时间t_5=t_3+\frac{S}{R}+RTT=3RTT+\frac{2S}{R}+t_0\\
&第八分组传输出去，第五分组的ack刚好达到服务器时，窗口大小增大为6，且有三空闲，立即连续发送第九分组。\\
&第九分组传输出去，第六分组的ack刚好达到服务器时，窗口大小增大为7，且有四空闲，立即连续发送第十分组。\\
&第十分组传输出去，第七分组的ack刚好达到服务器时，窗口大小增大为8，且有五空闲，立即连续发送第十一分组。\\
&显然后面的第八第十五分组是连续发送的\\
&服务端将第十五分组传输完成时刻t_6=t_5+\frac{8S}{R}=3RTT+\frac{10S}{R}+t_0\\
&客户端接收完第十五分组所需的总时间t=3RTT+\frac{10S}{R}+2RTT+\frac{S}{R}=5RTT+\frac{11S}{R}
\end{aligned}
$$

$$
\begin{aligned}
&c:\\
&记服务端传输完第一个分组的时间为t_0\\
&服务端接收到第一个分组的ack并开始传输第二分组的时间t_1=RTT+t_0\\
&服务端传输完第二分组并开始传输第三分组的时间t_2=t_1+\frac{S}{R}=RTT+\frac{S}{R}+t_0\\
&由\frac{S}{R} >RTT，从传输第三个分组起，每次传输完的一个分组时已收到上一个分组的ack\\
&服务端将第十五分组传输完成时间t_3=t_2+\frac{13S}{R}=RTT+\frac{14S}{R}+t_0\\
&客户端接收完第十五分组所需的总时间t=RTT+\frac{14S}{R}+2RTT+\frac{S}{R}=3RTT+\frac{15S}{R}
\end{aligned}
$$

##### （二）拥塞避免

* 每经过一个往返时延RTT就把发送方的拥塞窗口cwnd加1。

  目的是迅速减少主机发送到网络中的分组数，使得发生拥塞的路由器有足够时间把队列中积压的分组处理完。

* `TCP Reno`下，若收到3个冗余ACK，则ssthresh变为原来cwnd的一半，cwnd变为原来的一半+3（即所谓的快速恢复）。

  cwnd变为原来的一半（向下取整）+3该方式为计网黑书上的计算方式，有些参考书不采用加3，做题时稍微判断下。

* 若超时，则ssthresh变为原来cwnd的一半（向下取整），cwnd变为1，进入慢启动阶段。

##### （三）快速恢复

