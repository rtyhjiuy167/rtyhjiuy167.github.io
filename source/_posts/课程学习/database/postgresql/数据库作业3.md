### 第三次 “数据库原理及应用”课程实践大作业

####                                  学号：2020090916004 姓名：徐安瑞

**在一个成绩管理系统数据库GradeDB中，定义如下关系表：**

**STUDENT(SID,SName,Age,Sex)**

**GRADE(SID,CID,Score, Note)**

**COURSE(CID,CName,Teacher)**

**（1）编写SQL程序创建数据库及其关系表，并插入10个学生的2门课程（“数据库原理及应用”、“数据结构与算法”）成绩数据；**

1.创建数据库：

```sql
create database GradeDB;
```

<img src="C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20220515183919800.png" alt="image-20220515183919800" style="zoom:33%;" />

2.创建表：

```sql
create table STUDENT(
SID character(10) NOT NULL UNIQUE,
SName varchar(10) NOT NULL,
age numeric not NULL,
sex character(2)
);

CREATE TABLE COURSE(
CID character(10) NOT NULL UNIQUE,
CName varchar(10) NOT NULL,
Teacher varchar(10) NOT NULL
);
CREATE TABLE GRADE(
	SID character(10) NOT NULL,
	CID character(10) NOT NULL,
	Score numeric(5,1),
	Note character(10),
	CONSTRAINT SID_FK FOREIGN KEY(SID) 
		REFERENCES STUDENT(SID) ON DELETE CASCADE,
    CONSTRAINT CID_FK FOREIGN KEY(CID) 
		REFERENCES COURSE(CID) ON DELETE CASCADE
);
```

<img src="C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20220515183803978.png" alt="image-20220515183803978" style="zoom:50%;" />



3.插入数据

```sql
insert into COURSE (CID,CName,Teacher) values('0987654321','数据库原理及应用','张三');
insert into COURSE (CID,CName,Teacher) values('0987654322','数据库结构与算法','李四');
insert into STUDENT (SID,SName,age,sex) values('1234567890','李四',21,'男');
insert into STUDENT (SID,SName,age,sex) values('1234567891','王五',20,'男');
insert into STUDENT (SID,SName,age,sex) values('1234567892','甲',21,'女');
insert into STUDENT (SID,SName,age,sex) values('1234567893','李7',21,'男');
insert into STUDENT (SID,SName,age,sex) values('1234567894','李8',21,'男');
insert into STUDENT (SID,SName,age,sex) values('1234567895','李9',21,'男');
insert into STUDENT (SID,SName,age,sex) values('1234567896','李0',21,'男');
insert into STUDENT (SID,SName,age,sex) values('1234567897','李1',21,'男');
insert into STUDENT (SID,SName,age,sex) values('1234567898','李2',21,'男');
insert into STUDENT (SID,SName,age,sex) values('1234567899','李3',21,'男');

insert into GRADE (SID,CID,Score) values('1234567890','0987654321',40);
insert into GRADE (SID,CID,Score) values('1234567891','0987654321',71);
insert into GRADE (SID,CID,Score) values('1234567892','0987654321',62);
insert into GRADE (SID,CID,Score) values('1234567893','0987654321',33);
insert into GRADE (SID,CID,Score) values('1234567894','0987654321',54);
insert into GRADE (SID,CID,Score) values('1234567895','0987654321',85);
insert into GRADE (SID,CID,Score) values('1234567896','0987654321',66);
insert into GRADE (SID,CID,Score) values('1234567897','0987654321',47);
insert into GRADE (SID,CID,Score) values('1234567898','0987654321',78);
insert into GRADE (SID,CID,Score) values('1234567899','0987654321',69);

insert into GRADE (SID,CID,Score) values('1234567890','0987654322',99); 
insert into GRADE (SID,CID,Score) values('1234567891','0987654322',48); 
insert into GRADE (SID,CID,Score) values('1234567892','0987654322',67); 
insert into GRADE (SID,CID,Score) values('1234567893','0987654322',36); 
insert into GRADE (SID,CID,Score) values('1234567894','0987654322',45); 
insert into GRADE (SID,CID,Score) values('1234567895','0987654322',94); 
insert into GRADE (SID,CID,Score) values('1234567896','0987654322',53); 
insert into GRADE (SID,CID,Score) values('1234567897','0987654322',72); 
insert into GRADE (SID,CID,Score) values('1234567898','0987654322',41); 
insert into GRADE (SID,CID,Score) values('1234567899','0987654322',50); 
```

```sql
insert into GRADE (SID,CID,Score) values('1234567890','0987654321',40);
insert into GRADE (SID,CID,Score) values('1234567891','0987654321',71);
insert into GRADE (SID,CID,Score) values('1234567892','0987654321',62);
insert into GRADE (SID,CID,Score) values('1234567893','0987654321',33);
insert into GRADE (SID,CID,Score) values('1234567894','0987654321',54);
insert into GRADE (SID,CID,Score) values('1234567895','0987654321',85);
insert into GRADE (SID,CID,Score) values('1234567896','0987654321',66);
insert into GRADE (SID,CID,Score) values('1234567897','0987654321',47);
insert into GRADE (SID,CID,Score) values('1234567898','0987654321',78);
insert into GRADE (SID,CID,Score) values('1234567899','0987654321',69);

insert into GRADE (SID,CID,Score) values('1234567890','0987654322',99); 
insert into GRADE (SID,CID,Score) values('1234567891','0987654322',48); 
insert into GRADE (SID,CID,Score) values('1234567892','0987654322',67); 
insert into GRADE (SID,CID,Score) values('1234567893','0987654322',36); 
insert into GRADE (SID,CID,Score) values('1234567894','0987654322',45); 
insert into GRADE (SID,CID,Score) values('1234567895','0987654322',94); 
insert into GRADE (SID,CID,Score) values('1234567896','0987654322',53); 
insert into GRADE (SID,CID,Score) values('1234567897','0987654322',72); 
insert into GRADE (SID,CID,Score) values('1234567898','0987654322',41); 
insert into GRADE (SID,CID,Score) values('1234567899','0987654322',50); 
```

<img src="C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20220515183942787.png" alt="image-20220515183942787" style="zoom:33%;" />

（2）编写触发器程序实现GRADE表数据修改在日志表（GradeLOG）记录相关操作数据，如操作用户、学号、课程号、修改时间、修改前成绩、修改后成绩。

1.创建日志表：

```sql
CREATE TABLE GradeLOG(
username character(20),
sid character(10),
cid character(10),
updatatime text,
oldscore numeric(5,1),
newscore numeric(5,1)
);
```

<img src="C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20220515183954160.png" alt="image-20220515183954160" style="zoom:33%;" />

2.创建存储过程函数

```sql
CREATE OR REPLACE FUNCTION GRADE_audit()
RETURNS TRIGGER AS $GRADE_audit$
BEGIN
	IF (TG_OP = 'DELETE') THEN
		INSERT INTO GradeLOG SELECT user,old.sid,old.cid,now(),old.score;
			RETURN OLD;
		ELSIF (TG_OP = 'UPDATE') THEN
			INSERT INTO GradeLOG
			SELECT user,old.sid,old.cid,now(),old.score,new.score
			where old.sid=new.sid and old.cid=new.cid;
			RETURN NEW;
		ELSIF (TG_OP = 'INSERT') THEN
			INSERT INTO GradeLOG
				SELECT user,new.sid,new.cid,now(),null,new.score;
			RETURN NEW;
		END IF;
		RETURN NULL;
	END;
$GRADE_audit$ LANGUAGE plpgsql;
```

<img src="C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20220515184019505.png" alt="image-20220515184019505" style="zoom:33%;" />

3.创建触发器

```sql
CREATE TRIGGER Grade_audit_trigger
AFTER INSERT OR UPDATE OR DELETE ON Grade
FOR EACH ROW EXECUTE PROCEDURE GRADE_audit();
```

<img src="C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20220515184030257.png" alt="image-20220515184030257" style="zoom:33%;" />

4.试修改数据并查询结果

```sql
Update GRADE set Score=100 where CID='1234567891' and SID='0987654322';
```

<img src="C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20220515185058913.png" alt="image-20220515185058913" style="zoom:50%;" />

```sql
select * from GradeLOG
```

<img src="C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20220515185127656.png" alt="image-20220515185127656" style="zoom:33%;" />

（3）编写存储过程程序实现统计各课程不及格学生人数，并在屏幕输出

1.编写存储过程:

```sql
CREATE OR REPLACE FUNCTION public.my_func(OUT counter1 numeric,OUT counter2 numeric)
    RETURNS record
    LANGUAGE 'plpgsql'
AS $BODY$
BEGIN
    Select count(SID) INTO counter1 FROM GRADE where Score < 60 and CID='0987654322';
    Select count(SID) INTO counter2 FROM GRADE where Score < 60 and CID='0987654321';
END;
$BODY$;
```

<img src="C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20220515185156497.png" alt="image-20220515185156497" style="zoom:33%;" />

2.统计各课程不及格学生人数

```sql
select * from my_func()
```

<img src="C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20220515185517731.png" alt="image-20220515185517731" style="zoom:50%;" />

从上图可知，不及格的人数各为5人和4人。
