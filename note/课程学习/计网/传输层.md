功能：

* 传输层提供应用进程之间的逻辑通信（即端到端的通信）

  与网络层的区别是，网络层提供的是主机之间的逻辑通信。

* 多路复用和分解

  多路复用指在源主机从不同套接字中手机数据块，并为每个数据块封装上首部信息从而生成报文端，然后将报文段传递给网络层

  多路分解指将运输层报文段中的数据交付到正确的套接字的工作

* 对收到的报文进行差错检测（首部和数据部分）

  网络层只检查IP数据报的首部，不检查数据部分是否出错

* 提供两种不同的传输协议，即TCP与UDP

  在网络层要么只提供面向连接的服务，如虚电路；要么只提供无连接的服务，如数据报，而不可能在网络层同时存在这两种方式

不提供时延保证、带宽保证

## TCP

TCP套接字是由一个四元组（源IP地址、源端口号、目的IP地址、目的端口号）来标识的。

* 每条TCP连接只能有两个端点，每条TCP连接只能是端到端的

* TCP是面向字节流的

* TCP提供全双工通信，允许通信双方的应用进程在任何时候都能发送数据，为此TCP连接的两端都设有发送缓存和接收缓存。

  发送缓存用来暂时存放以下数据：

  * 发送应用程序传送给发送方TCP准备发送的数据
  * TCP已发送但尚未收到确认的数据

  接收缓存用来暂时存放以下数据：

  * 按序到达但尚未被接收应用程序读取的数据
  * 不按序到达的数据

TCP报文长度根据接收方给出的窗口之和当前网络拥塞程度来决定。

#### TCP报文段

TCP首部：

<img src=".\picture\TCP首部.png" alt="TCP首部" style="zoom:60%;" />

确认号：期望收到对方下一个报文段的第一个数据字节的序号

数据偏移：标识首部长度，它指出TCP报文段的数据起始处距离TCP报文段的起始处有多远。单位：4B。TCP首部的最大长度为60B

紧急位URG

确认位ACK：仅当ACK=1时确认号字段才有效

推送位PSH

复位位RST

同步位SYN：当SYN=1时表示这是一个连接请求或连接接收报文

终止位FIN：当FIN=1时，表示此报文段的发送方的数据已发送完毕，并要求释放运输连接

窗口：它指出现在允许对方发送的数据量，接收方的数据缓存空间是有限的，因此用窗口值作为让发送方设置其发送窗口的依据

校验和：校验和字段检验的范围包括首部和数据两部分

#### 连接管理

每个TCP都有三个阶段：连接建立、数据传送和连接释放

1）连接建立

第一步：客户机的TCP首先向服务器的TCP发送连接请求报文段。此时，TCP客户进程进入SYN-SENT（同步已发送）状态

第二步：服务器的TCP收到连接请求报文段后，如统一建立连接，则向客户机发回确认，并为该TCP连接分配缓存和变量。此时，TCP服务器进程进入SYN-RCVD（同步收到）状态

第三步：当客户机收到确认报文段后，还要向服务器给出确认，并未该TCP连接分配缓存和变量。此时，TCP客户进程进入ESTABLISHED（已建立连接）状态

起始发送数据的序号为发送的SYN段中的序号加1

服务器端的资源是在完成第二次握手时分配的，而客户端的资源是在完成第三次握手时分配的，这使得服务器易于收到SYN泛洪攻击。

2）连接释放

TCP的连接释放的过程通常称为四次握手

第一步：客户机打算关闭连接时，向其TCP发送连接释放报文段，并停止发送数据，并主动关闭TCP连接。客户机进程进入FIN-WAIT-1（终止等待1）状态

第二步：服务器收到连接释放报文段后立即发出确认，然后服务器进入CLOSE_WAIT状态。此时，从客户机到服务器这个方向的连接就释放了，TCP连接处于半关闭状态。

第三步：若服务器已经没有要向客户机发送的数据时，就通知TCP释放连接。这是服务器进入LAST-ACK（最后确认）状态

第四步：客户机收到连接释放报文段后，必须发出确认。此时TCP连接还未释放，客户的TCP状态为TIME_WAIT。在经过2MSL（最大报文段寿命）后，客户机才进入CLOSED（连接关闭）状态。

最后发送数据的序号为发送的FIN段中的序号减1

#### TCP可靠传输

TCP的任务时在IP层不可靠的、尽力而为服务的基础上建立一种可靠数据传输服务。

TCP提供的可靠数据传输服务保证接收方进程从缓存区读出的字节流与发送方发出的字节流完全一样。

TCP使用如下机制来达到这一目的：

1）序号

TCP连接传送的数据流中的每个字节都编上一个序号

2）确认

TCP默认使用累积确认。TCP对每个字节编号，但并不是接收到每个字节都要发回确认，而是在发送一个报文段的字节后才发回一个确认，所以TCP采用的是对**报文段**的确认机制。

例如发送过程中序号为100的确认报文段丢失，而发送方又收到了序号为120的确认报文，则认为接收方收到了120号之前的所有内容（实际也的确收到了，不然是不会发确认号为120的确认报文的）

3）重传

有两种事件会导致TCP对报文段进行重传：超时和冗余ACK

* 超时

  TCP每发送一个报文段，就对这个报文段设置一次计时器。计时器设置的重传时间到期但还未收到确认时，就要重传这一报文段。

* 冗余ACK（冗余确认、快速重传）

  TCP规定每当比期望序号大的失序报文段到达时，就发送一个冗余ACK，指明下一个期待字节的序号。当发送方收到对同一个报文段的3个冗余ACK时，就可以认为跟在这个被确认报文段之后的报文段已经丢失，发送方会立即重传接收方所期待的报文。

解决流水线的差错恢复有两种基本方法：

* 回退N步（Go-Back-N，GBN）

  失序超时即重传确认号及之后的所有报文

* 选择重传（Selective Repeat，SR）

  SR接收方将确认一个正确接收的分组而不管其是否按序。失序的分组将被缓存直到所有丢失分组皆被收到为之，这时才可以将一批分组按序交付给上层。

4）校验

#### TCP流量控制

TCP提供流量控制服务来消除发送方发送速率太快使接收方缓存区溢出的可能性。

TCP提供一种基于滑动窗口协议的流量控制机制。

传输层和数据链路层的流量控制的区别：1.传输层定义端到端用户之间的流量控制，数据链路层定义两个中间的相邻结点的流量控制。2.数据链路层的滑动窗口协议的窗口大小不能动态变化，传输层则可以动态变化。

#### TCP拥塞控制

拥塞控制是指防止过多的数据注入网络，保证网络中的路由器或链路不致过载。

拥塞控制与流量控制的区别：拥塞控制是让网络能够承受现有的网络负荷，是一个全局性的过程，涉及所有的主机、路由器，以及与降低网络传输性能有关的所有因素。而流量控制往往指点对点的通信量的控制，是端到端的问题，它所要做的是抑制发送端发送数据的速率，以便使接收端来得及接收。

TCP协议要求**发送方**维护以下接收窗口和拥塞窗口，且发送窗口的上限值为min[rwnd，cwnd]

1）接收窗口rwnd

接收方根据目前接收缓存大小所许诺的最新窗口值，反映接收方的容量。由接收方根据其放在TCP报文的首部的窗口字段通知发送方

2）拥塞窗口cwnd

发送方根据自己估算的网络拥塞程度而设置的窗口值，反映网络的当前容量。

* 慢开始算法

  在TCP刚刚连接好并开始发送TCP报文段时，先令拥塞窗口cwnd=1（目的是试探网络的拥塞情况），即一个最大报文段长度MSS。之后每收到一个对新报文段的确认后，将cwnd加1，即增大一个MSS（相当于每隔一个RTT时间，报文段发送数量增加一倍，cwnd也增加一倍）。当cwnd增大到一个规定的ssthresh阈值时，然后改用拥塞控制算法。

  在慢开始阶段，若2cwnd>ssthresh，则下一个RTT后的cwnd等于ssthresh，而不等于2cwnd

* 拥塞避免算法

  每经过一个往返时延RTT就把发送方的拥塞窗口cwnd加1

  目的是迅速减少主机发送到网络中的分组数，使得发生拥塞的路由器有足够时间把队列中积压的分组处理完。

* 快重传算法

  当发送方收到对同一个报文段的3个冗余ACK时，就可以认为跟在这个被确认报文段之后的报文段已经丢失，发送方会立即重传接收方所期待的报文。

* 快恢复算法

  当发送方收到3个冗余ACK时，说明（在接收方发送三个冗余ACK前已）发生丢包，（发生丢包时）将ssthresh、cwnd设置为此时发送方cwnd值的一半，接下来进入快速恢复状态。之后每收到一个冗余ACK后（包括检测丢包发生的三个冗余ACK），cwnd+1，直至收到丢失报文段的一个ACK到达，然后cwnd=ssthresh（cwnd又变为之前的一半了），进入拥塞避免状态

## UDP

UDP套接字是由一个二元组（目的IP地址、目的端口号）来标识的

UDP仅在IP的数据报服务之上增加了两个最基本的服务：复用和分用以及差错检测。

* UDP无需建立连接。因此UDP不会引入建立连接的时延

* 无连接状态

* 分组首部开销小

  应用层能更好地控制要发送地数据和发送时间。UDP没有拥塞控制，因此网络中的拥塞不会影响主机的发送效率。

* UDP是面向报文的

UDP不保证可靠交付，但这并不意味着应用对数据的要求是不可靠的，所有维护可靠性的工作可有用户在应用层来完成。

UDP报文长度由发送应用程序决定

#### UDP首部

UDP首部有8B，由四个字段组成，每个字段的长度都是2B。

<img src=".\picture\UDP首部.png" alt="UDP首部" style="zoom:80%;" />

1）源端口

2）目的端口

3）长度

4）UDP校验和

UDP校验和不是必需的，如果不使用校验和，那么将校验和字段设置为0，而如果校验和的计算结果恰好为0，那么将校验和字段置为全1.

#### UDP校验

在计算校验和时，要在UDP数据报之前增加12B的伪首部，伪首部并不是UDP的真正首部。只是在计算校验和时，临时添加在UDP数据报的前面，得到一个临时的UDP数据报。伪首部既不向下传送又不向上递交，而只是为了计算校验和。

<img src=".\picture\UDP伪首部.png" alt="UDP伪首部" style="zoom:80%;" />

IP数据报的校验和只检验IP数据报的首部，但UDP的校验和则检查首部和数据部分。

<img src=".\picture\UDP校验和.png" alt="UDP校验和" style="zoom:80%;" />



例题：一个UDP用户数据报的数据字段为8192B，要使用以太网来传送。假定IP数据报无选项。试问应当划分为几个IP数据报片？说明每个IP数据报片的数据字段程度和片段偏移字段的值

解：UDP用户数据报的数据字段为8192B，加上8B的首部，所以IP数据部分总长度为8200B。IP数据报首部长度为20B，而以太网帧的数据段的最大长度是1500B，1480B的数据部分和20B的IP首部，由1480n≥8200，所以应当划分为6个IP报片。而片偏移的单位是8B。

|              |   1   |   2   |   3   |   4   |   5   |  6   |
| :----------: | :---: | :---: | :---: | :---: | :---: | :--: |
| IP报片总长度 | 1500B | 1500B | 1500B | 1500B | 1500B | 820B |
|   数据偏移   | 1480B | 1480B | 1480B | 1480B | 1480B | 800B |
|    片偏移    |   0   |  185  |  370  |  555  |  740  | 925  |

