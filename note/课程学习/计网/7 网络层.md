尽最大努力交付有何含义
1.不保证源主机发送的 IP 数据报一定无猜错地交付到目的主机
2.不保证源主机发送的 IP 数据报都在某一规定的时间内交付到目的主机
3.不保证源主机发送的 IP 数据报一定按发送时的顺序交付到目的主机
4.不保证源主机发送的 IP 数据报不会重复交付给目的主机
5.不故意丢弃 IP 数据报。丢弃 IP 数据报的情况是：路由器检测出首部校验和有错误；或由于网络中通信量过大，路由器或目的主机中的缓存已无空闲空间

## SDN

 网络层的主要任务是转发和路由选择。可以将网络层抽象地划分为数据层面和控制层面，转发是数据层面实现地功能，而路由选择是控制层面实现的功能。

软件定义网络（Software-Define Networking，SDN）采用集中式的控制层面和分布式的数据层面，两个层面相互分离，控制层面利用控制-数据接口对数据层面上的路由器进行集中式控制，方便软件来控制网络。

转发是指将分组从一个输入链路接口转移到适当的输出接口的路由器本地动作。在数据平面中，且通常由硬件实现。

路由选择是指将确定分组从源到目的地所采取的端到端路径的网络范围处理过程。在控制平面中，且通常由软件实现。

#### OpenFlow

是SDN中控制器与转发层之间的通信接口标准

数据平面采用基于流的方式进行转发

OpenFlow网络由 OpenFlow网络设备（OpenFlow Switch）和控制器（OpenFlow Controller）通过OpenFlow通道（OpenFlow Channel）组成

匹配交动作转发表在OpenFlow中称为流表

## 路由器

1）输入端口

在输入端口，使用转发表来查找输出端口，是到达的分组能经过交换结构转发到该输出接口。

转发的两个主要操作：匹配和动作

* 基于目的地的转发，路由器的匹配操作仅查找待转发数据报的目的IP地址，路由器的动作操作包括将数据包发送到交换结构到指定的输出端口。
* 通用转发，可以在与协议栈中不同层的不同协议相关联的多个报头字段上进行匹配，并且动作可以包括将分组转发到一个或多个输出端口，跨多个输出接口对数据包进行负载平衡，重写报头值（如在NAT中），有目的地阻止/丢弃数据包（如在防火墙中），将数据包发送到特殊服务器以进行进一步处理和操作等等



硬件实现

2）交换结构

交换结构将路由器的输入端口连接到它的输出端口。这种交换结构完全包含在路由器之中，它是一个网络路由器中的网络。

硬件实现

从一个输入端口交换（即转发）到一个输出端口，有经内存交换、经总线交换、经互联网交换三种方式。

<img src=".\picture\三种交换技术.png" alt="三种交换技术" style="zoom:80%;" />

* 经内存交换

  最简单、最早的路由器是传统的计算机，在输入端口与输出端口之间的交换是在CPU（路由选择处理器）的直接控制下完成的。

  当分组到达输入端口时，该端口通过中断方式向路由选择处理器发出信号，将分组拷贝到处理器内存中。路由选择处理器根据分组中的目的地址查表找出适当的输出端口，将该分组拷贝到输出端口的缓存中。每个分组穿过了两次总线（将分组拷贝到处理器内存，要先写；又因为也要拷贝到输出端口的缓存中，要从内存读，所以总线穿过两次）。

  交换速度受总线带宽的速度限制 ，若总线带宽为每秒写入或读出B个分组，则总的转发吞吐量 (分组从输入端口被传送到输出端口的总速率)小于B/2。

* 经总线交换

  输入端口经一条共享总线将分组直接传送到输出端口，不需要路由选择处理器的干预。

  每次只能有一个分组通过总线传送

  路由器交换带宽受总线速率限制

* 经互联网交换（交换矩阵）

  纵横式交换机：由2n条总线组成，n个输入端口与n个输出端口连接。

  到达输入端口的分组沿水平总线穿行，直至与所希望的输出端口的垂直总线交叉点：

  * 若该条垂直总线空闲，则分组被传送到输出端口；

  * 否则，该到达的分组被阻塞，必须在输入端口排队。

3）输出端口

输出端口存储从交换结构接收的的分组，并通过执行必要的链路层和物理层功能在输出链路上传输这些分组。

硬件实现

4）路由选择处理器

路由选择处理器执行控制平面功能

使用软件来执行路由协议

路由器主要功能：

* 路由选择

  指按照复杂的分布式算法，根据从各相邻路由器所得到的关于整个网络拓扑的变化情况，动态地改变所选择的路由。

* 分组转发

  指路由器根据转发表将用户的IP数据报从合适的端口转发出去。



## 异构网络互联

在路由器互联的多个局域网的结构中，每个局域网物理层、数据链路层、网络层协议可以不同，但网络层以上的高层协议必须相同。

路由器是一台专用计算机，用于在互联网中进行路由选择。

## 拥塞控制

拥塞控制方法：

* 开环控制（静态）

  在设计网络时事先将有关发生拥塞的因素考虑周到，力求网络在工作时不产生拥塞。一旦整个系统启动并运行，中途就不再需要修改。

* 闭环控制（动态）

  事先不考虑有关发生拥塞的各种因素，才监测网络系统区监视，及时检测哪里发生了拥塞，然后将拥塞信息传到合适的地方，以便调整网络系统的运行，并解决出现的问题。

## IPv4

IP提供的是不可靠的服务。

#### IP数据报的格式

<img src=".\picture\IP数据报.png" alt="IP数据报" style="zoom:60%;" />

首部长度：占4位。以**32位**为单位，可知IP数据报首部的长度是32位的整数倍。最常用的首部长度是20B，此时不使用可选字段。

总长度——占 16 位，指首部和数据之和的长度，单位为字节，因此数据报的最大长度为 65535 字节。总长度必须不超过最大传送单元 MTU（一个链路层数据报所能承载的最大数据量称为最大传送单元）。

标识：同一数据报的分片使用同一标识。可理解为ID。

标志：占三位。最高位无意义。标志字段的最低位为MF（More Fragment），MF=1表示后面还有分片，MF=0表示最后一个分片或没有分片。标志字段中间的一位是DF（Don't Fragment），只有当DF=0时才允许有分片。

片偏移：它指出较长的分组在分片后，某片在原分组中的相对位置。单位为**8字节**。可知每片都为8字节的整数倍。

生存时间：占8 位，记为 TTL (Time To Live)，数据报在网络中可通过的路由器数的最大值。

协议：占8位。支出此分组携带的数据使用何种协议，即分组的数据部分应上交给哪个协议进行处理。其中值为6表示TCP，值为17表示UDP

首部检验和：占16位。首部检验和只检验分组的首部，而不检验数据部分。

#### 分类的IP地址

IP地址：全世界唯一的32位标识符，标识路由器主机的接口

IP地址：网络号，主机号

A类网络中最多可有2<sup>24</sup>台主机或路由器

<img src=".\picture\分类的IP地址.png" alt="分类的IP地址" style="zoom:80%;" />

IP地址空间的利用率有时很低。例如某公司已申请A类的网络号，但其公司的主机根本没有那么多。

两级地址不够灵活。例如，某公司想再要一个网络号，需要向 ISP 申请 

#### 子网划分

子网划分，在IP地址中增加了一个子网号字段，使两级IP地址变成了三级IP地址。

三级IP地址的结构：{<网络号>，<子网号>，<主机号>}

网络掩码：对应网络号，全0，对应主机号全1

|      两级IP地址      |   XXX    |   XXX    |   XXX    |   XXX    |
| :------------------: | :------: | :------: | :------: | :------: |
| 两级IP地址的子网掩码 | 11111111 | 11111111 | 00000000 | 00000000 |
|      三级IP地址      |   XXX    |   XXX    |   XXX    |   XXX    |
| 三级IP地址的子网掩码 | 11111111 | 11111111 | 11111111 | 00000000 |

子网掩码与IP地址逐位相与，就得到子网网络地址

|  二进制  | 十进制 |
| :------: | :----: |
| 10000000 |  128   |
| 11000000 |  192   |
| 11100000 |  224   |
| 11110000 |  240   |
| 11111000 |  248   |
| 11111100 |  252   |
| 11111110 |  254   |
| 11111111 |  255   |

#### 无分类编址 CIDR

消除了传统的A类、B类、C类以及划分子网的概念。融合子网地址与子网掩码，方便子网划分

无分类编址：{<网络前缀>，<主机号>/网络前缀位数}

构成超网：将多个子网聚合成一个较大的子网，叫做构成超网，或路由聚合。方法：将网络前缀缩短。

最长前缀匹配（最佳匹配）：使用 CIDR 时，路由表中的每个项目由“网络前缀”和“下一跳地址”组成。在查找路由表时，可能会得到不止一个匹配结果。此时，应当从匹配结果中选择具有最长网络前缀的路由，因为网络前缀越长，其地址块就越小，因而路由就越具体。

#### 网络地址转换

网络地址转换（Network Address Translation，NAT）是指通过将专用网络地址转换为公用地址，从而对外隐藏内部管理的IP地址。它使得整个专用网只需要一个全球IP地址就可以与因特网连通，由于专用网本地IP地址是可重用的，所以NAT大大节省了IP地址的消耗。同时，它隐藏了内部网络结构，从降低了内部网络受到攻击的风险。

安装了NAT软件的路由器叫NAT路由器，它至少有一个有效的外部全球IP地址。NAT路由器工作在传输层。

根据NAT协议，下列网络（即私有IP）不允许出现因特网上。

| 地址类别 |           地址范围            | 网段个数 |
| :------: | :---------------------------: | :------: |
|   A类    |   10.0.0.0 ~ 10.255.255.255   |    1     |
|   B类    |  172.16.0.0 ~ 172.31.255.255  |    16    |
|   C类    | 192.168.0.0 ~ 192.168.255.255 |   255    |

路由器对目的地址是私有IP地址的数据报一律不进行转发。

§NAT 存在争议

* 路由器只应该处理到第三层
* 违反了端到端主张
* 应用程序设计者在设计时不得不将NAT加以考虑
* 应使用IPv6来解决地址短缺问题

#### 特殊IP

| NetWork Address(网络号或网络号+子网) |   Host Address    | 作为IP分组源地址 | 作为IP分组目的地址 |                       用途                       |
| :----------------------------------: | :---------------: | :--------------: | :----------------: | :----------------------------------------------: |
|                 全0                  |        全0        |       可以       |       不可以       |                                                  |
|                 全0                  |      特定值       |       可以       |       不可以       |              表示本网内某个特定主机              |
|                 全1                  |        全1        |      不可以      |        可以        |                 在本网内进行广播                 |
|                特定值                |        全0        |      不可以      |       不可以       |                   表示一个网络                   |
|                特定值                |        全1        |      不可以      |        可以        |               对特定的网络进行广播               |
|                 127                  | 任何数（非全0/1） |       可以       |        可以        | 用于本地软件环回测试(数据报无法离开主机进入网络) |

能作为IP分组的源IP地址，其网络号须全0；能作为IP分组的目的IP地址，其主机号须全1（127除外）
$$
\begin{aligned}
&某主机的IP地址为180.80.77.55，子网掩码为255.255.252.0。若该主机向其所在子网发送广播分组，则目的地址可以是？\\
解：&因为是向子网发送广播分组，直接由子网掩码里的1的个数判断网络号，即22位\\
&所以目的地址网络号可以是 180.80.76.0，主机号全1，所以目的地址为 180.80.79.0\\
\end{aligned}
$$

| 网络类别 |           最大可用网络数           | 第一个可用的网络号 | 最后一个可用的网络号 | 每个网络中的最大主机数 |
| :------: | :--------------------------------: | :----------------: | :------------------: | :--------------------: |
|    A     | 2<sup>7</sup>-2 (不能使用全0与127) |         1          |         126          |    2<sup>24</sup>-2    |
|    B     |           2<sup>14</sup>           |       128.1        |       191.255        |    2<sup>16</sup>-2    |
|    C     |           2<sup>21</sup>           |      192.0.1       |     223.255.255      |    2<sup>8</sup>-2     |

|  二进制  | 十进制 |
| :------: | :----: |
| 10000000 |  128   |
| 11000000 |  192   |
| 11100000 |  224   |
| 11110000 |  240   |
| 11111000 |  248   |
| 11111100 |  252   |
| 11111110 |  254   |
| 11111111 |  255   |

### ARP、DHCP、ICMP

#### IP地址与硬件地址

IP地址是网络层使用的地址，它是分层次等级的。硬件地址是数据链路层使用的地址（MAC地址），它是平面式的。在网络层及网络层之上使用IP地址，IP地址放在IP数据报的首部，而MAC地址放在MAC帧的首部。通过数据封装，把IP数据报分组封装为MAC帧后，数据链路层看不见数据报分组中的IP地址。

路由器由于互联多个网络，因此它不仅有多个IP地址，也有多个硬件地址。

如果一台主机有两个或两个以上的IP地址，那么说明这台主机属于两个或两个以上的逻辑网络（A、B或C类）

#### 地址解析协议（ARP）

地址解析协议（Address Resolution Protocol，ARP）：完成主机或路由器IP地址到MAC地址的映射

每台主机都设有一个ARP高速缓存，用来存放本局域网上个主机和路由器的IP地址到MAC地址的映射，称ARP表。使用ARP来动态维护此ARP表。

ARP工作在网络层

ARP工作原理：主机A预向本局域网上的谋体主机B发送IP数据报时，先在其ARP高速缓存中查看有无主机B的IP地址。如果有，就可查出其对应的硬件地址，再将此硬件地址写入MAC真，然后通过局域网将该MAC帧发往此硬件地址。如果没有，那么久通过使用目的MAC地址为FF-FF-FF-FF-FF-FF的帧来封装并广播ARP请求分组，是同一个局域网里的所有主机都收到此ARP请求。主机B收到该ARP请求后，向主机A发出ARP响应分组（单播发送），分组中包含主机B的IP与MAC地址的映射关系，主机A收到ARP响应分组后就将映射写入ARP缓存，然后按查询到的硬件地址发送MAC帧。

在数据链路层，MAC地址用来表示主机或路由器，数据报到达具体的目的网络后，需要知道目的主机的MAC地址才能成功送达，因此需要将IP地址转换成对应的MAC地址，即物理地址。

数据链路层设备如交换机，是没有MAC地址的。

#### DHCP协议

动态主机配置协议（Dynamic Host Configuration Protocol，DHCP）常用于给主机动态分配IP地址，它提供了即插即用的联网机制，这种机制允许一台计算机加入新的网络和获取IP地址而不用手工参与。

DHCP是应用层协议，基于UDP，且使用客户/服务器模式。

1.主机广播DHCP发现报文。即主机问有没有DHCP服务器。

2.DHCP广播DHCP提供报文。DHCP说，有！有！有！

3.主机广播DHCP请求报文。主机说，那我用你给我的IP地址了哈。

4.DHCP服务器广播DHCP确认报文。DHCP说，用吧。

#### ICMP

网际控制报文协议（Internet Control Message Protocol，ICMP）

在TCP/IP体系结构中，直接为ICMP提供服务的协议是IP

为了提高IP数据报交付成功的机会，在网络层使用ICMP协议来让主机或路由器报告差错和异常情况。

ICMP报文的种类有两种，即ICMP差错报告报文和ICMP询问报文

ICMP差错报告报文类型：

* 终点不可达
* 源点抑制
* 时间超过
* 参数问题
* 改变路由（重定向）

不应发送ICMP差错报文的情况：

* 对ICMP差错报告报文不再发送ICMP差错报告报文
* 对第一个分片的数据报片的所有后续数据薄片都不发送ICMP差错报文
* 对具有组播地址的数据报都不发送ICMP差错报告报文
* 对具有特殊地址的数据报不发送ICMP差错报告报文

ICMP询问报文类型：1.回送请求和回答报文。2.时间戳请求和回答报文。3.地址掩码请求和回答报文。4.路由器询问和通告报文。

ICMP的两个常见应用是分组网间探测PING（用来测试两台主机之间的联通性）和Traceroute（用来跟踪分组经过的路由）。PING使用了回送请求和回答报文，Traceroute（Tracert）使用了时间超过报文。

PING工作在应用层，它直接使用网络层的ICMP，而未使用传输层的TCP或UDP，Traceroute（Tracert）工作在网络层。



